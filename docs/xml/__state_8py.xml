<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.15.0" xml:lang="es">
  <compounddef id="__state_8py" kind="file" language="Python">
    <compoundname>_state.py</compoundname>
    <innerclass refid="classh11_1_1__state_1_1_c_l_i_e_n_t" prot="public">h11::_state::CLIENT</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_s_e_r_v_e_r" prot="public">h11::_state::SERVER</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_i_d_l_e" prot="public">h11::_state::IDLE</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_s_e_n_d___r_e_s_p_o_n_s_e" prot="public">h11::_state::SEND_RESPONSE</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_s_e_n_d___b_o_d_y" prot="public">h11::_state::SEND_BODY</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_d_o_n_e" prot="public">h11::_state::DONE</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_m_u_s_t___c_l_o_s_e" prot="public">h11::_state::MUST_CLOSE</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_c_l_o_s_e_d" prot="public">h11::_state::CLOSED</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_e_r_r_o_r" prot="public">h11::_state::ERROR</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_m_i_g_h_t___s_w_i_t_c_h___p_r_o_t_o_c_o_l" prot="public">h11::_state::MIGHT_SWITCH_PROTOCOL</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_s_w_i_t_c_h_e_d___p_r_o_t_o_c_o_l" prot="public">h11::_state::SWITCHED_PROTOCOL</innerclass>
    <innerclass refid="classh11_1_1__state_1_1___s_w_i_t_c_h___u_p_g_r_a_d_e" prot="protected">h11::_state::_SWITCH_UPGRADE</innerclass>
    <innerclass refid="classh11_1_1__state_1_1___s_w_i_t_c_h___c_o_n_n_e_c_t" prot="protected">h11::_state::_SWITCH_CONNECT</innerclass>
    <innerclass refid="classh11_1_1__state_1_1_connection_state" prot="public">h11::_state::ConnectionState</innerclass>
    <innernamespace refid="namespaceh11">h11</innernamespace>
    <innernamespace refid="namespaceh11_1_1__state">h11::_state</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1" refid="namespaceh11_1_1__state" refkind="compound"><highlight class="comment">################################################################</highlight></codeline>
<codeline lineno="2"><highlight class="comment">#<sp/>The<sp/>core<sp/>state<sp/>machine</highlight></codeline>
<codeline lineno="3"><highlight class="comment">################################################################</highlight></codeline>
<codeline lineno="4"><highlight class="comment">#</highlight></codeline>
<codeline lineno="5"><highlight class="comment">#<sp/>Rule<sp/>1:<sp/>everything<sp/>that<sp/>affects<sp/>the<sp/>state<sp/>machine<sp/>and<sp/>state<sp/>transitions<sp/>must</highlight></codeline>
<codeline lineno="6"><highlight class="comment">#<sp/>live<sp/>here<sp/>in<sp/>this<sp/>file.<sp/>As<sp/>much<sp/>as<sp/>possible<sp/>goes<sp/>into<sp/>the<sp/>table-based</highlight></codeline>
<codeline lineno="7"><highlight class="comment">#<sp/>representation,<sp/>but<sp/>for<sp/>the<sp/>bits<sp/>that<sp/>don&apos;t<sp/>quite<sp/>fit,<sp/>the<sp/>actual<sp/>code<sp/>and</highlight></codeline>
<codeline lineno="8"><highlight class="comment">#<sp/>state<sp/>must<sp/>nonetheless<sp/>live<sp/>here.</highlight></codeline>
<codeline lineno="9"><highlight class="comment">#</highlight></codeline>
<codeline lineno="10"><highlight class="comment">#<sp/>Rule<sp/>2:<sp/>this<sp/>file<sp/>does<sp/>not<sp/>know<sp/>about<sp/>what<sp/>role<sp/>we&apos;re<sp/>playing;<sp/>it<sp/>only<sp/>knows</highlight></codeline>
<codeline lineno="11"><highlight class="comment">#<sp/>about<sp/>HTTP<sp/>request/response<sp/>cycles<sp/>in<sp/>the<sp/>abstract.<sp/>This<sp/>ensures<sp/>that<sp/>we</highlight></codeline>
<codeline lineno="12"><highlight class="comment">#<sp/>don&apos;t<sp/>cheat<sp/>and<sp/>apply<sp/>different<sp/>rules<sp/>to<sp/>local<sp/>and<sp/>remote<sp/>parties.</highlight></codeline>
<codeline lineno="13"><highlight class="comment">#</highlight></codeline>
<codeline lineno="14"><highlight class="comment">#</highlight></codeline>
<codeline lineno="15"><highlight class="comment">#<sp/>Theory<sp/>of<sp/>operation</highlight></codeline>
<codeline lineno="16"><highlight class="comment">#<sp/>===================</highlight></codeline>
<codeline lineno="17"><highlight class="comment">#</highlight></codeline>
<codeline lineno="18"><highlight class="comment">#<sp/>Possibly<sp/>the<sp/>simplest<sp/>way<sp/>to<sp/>think<sp/>about<sp/>this<sp/>is<sp/>that<sp/>we<sp/>actually<sp/>have<sp/>5</highlight></codeline>
<codeline lineno="19"><highlight class="comment">#<sp/>different<sp/>state<sp/>machines<sp/>here.<sp/>Yes,<sp/>5.<sp/>These<sp/>are:</highlight></codeline>
<codeline lineno="20"><highlight class="comment">#</highlight></codeline>
<codeline lineno="21"><highlight class="comment">#<sp/>1)<sp/>The<sp/>client<sp/>state,<sp/>with<sp/>its<sp/>complicated<sp/>automaton<sp/>(see<sp/>the<sp/>docs)</highlight></codeline>
<codeline lineno="22"><highlight class="comment">#<sp/>2)<sp/>The<sp/>server<sp/>state,<sp/>with<sp/>its<sp/>complicated<sp/>automaton<sp/>(see<sp/>the<sp/>docs)</highlight></codeline>
<codeline lineno="23"><highlight class="comment">#<sp/>3)<sp/>The<sp/>keep-alive<sp/>state,<sp/>with<sp/>possible<sp/>states<sp/>{True,<sp/>False}</highlight></codeline>
<codeline lineno="24"><highlight class="comment">#<sp/>4)<sp/>The<sp/>SWITCH_CONNECT<sp/>state,<sp/>with<sp/>possible<sp/>states<sp/>{False,<sp/>True}</highlight></codeline>
<codeline lineno="25"><highlight class="comment">#<sp/>5)<sp/>The<sp/>SWITCH_UPGRADE<sp/>state,<sp/>with<sp/>possible<sp/>states<sp/>{False,<sp/>True}</highlight></codeline>
<codeline lineno="26"><highlight class="comment">#</highlight></codeline>
<codeline lineno="27"><highlight class="comment">#<sp/>For<sp/>(3)-(5),<sp/>the<sp/>first<sp/>state<sp/>listed<sp/>is<sp/>the<sp/>initial<sp/>state.</highlight></codeline>
<codeline lineno="28"><highlight class="comment">#</highlight></codeline>
<codeline lineno="29"><highlight class="comment">#<sp/>(1)-(3)<sp/>are<sp/>stored<sp/>explicitly<sp/>in<sp/>member<sp/>variables.<sp/>The<sp/>last</highlight></codeline>
<codeline lineno="30"><highlight class="comment">#<sp/>two<sp/>are<sp/>stored<sp/>implicitly<sp/>in<sp/>the<sp/>pending_switch_proposals<sp/>set<sp/>as:</highlight></codeline>
<codeline lineno="31"><highlight class="comment">#<sp/><sp/><sp/>(state<sp/>of<sp/>4)<sp/>==<sp/>(_SWITCH_CONNECT<sp/>in<sp/>pending_switch_proposals)</highlight></codeline>
<codeline lineno="32"><highlight class="comment">#<sp/><sp/><sp/>(state<sp/>of<sp/>5)<sp/>==<sp/>(_SWITCH_UPGRADE<sp/>in<sp/>pending_switch_proposals)</highlight></codeline>
<codeline lineno="33"><highlight class="comment">#</highlight></codeline>
<codeline lineno="34"><highlight class="comment">#<sp/>And<sp/>each<sp/>of<sp/>these<sp/>machines<sp/>has<sp/>two<sp/>different<sp/>kinds<sp/>of<sp/>transitions:</highlight></codeline>
<codeline lineno="35"><highlight class="comment">#</highlight></codeline>
<codeline lineno="36"><highlight class="comment">#<sp/>a)<sp/>Event-triggered</highlight></codeline>
<codeline lineno="37"><highlight class="comment">#<sp/>b)<sp/>State-triggered</highlight></codeline>
<codeline lineno="38"><highlight class="comment">#</highlight></codeline>
<codeline lineno="39"><highlight class="comment">#<sp/>Event<sp/>triggered<sp/>is<sp/>the<sp/>obvious<sp/>thing<sp/>that<sp/>you&apos;d<sp/>think<sp/>it<sp/>is:<sp/>some<sp/>event</highlight></codeline>
<codeline lineno="40"><highlight class="comment">#<sp/>happens,<sp/>and<sp/>if<sp/>it&apos;s<sp/>the<sp/>right<sp/>event<sp/>at<sp/>the<sp/>right<sp/>time<sp/>then<sp/>a<sp/>transition</highlight></codeline>
<codeline lineno="41"><highlight class="comment">#<sp/>happens.<sp/>But<sp/>there<sp/>are<sp/>somewhat<sp/>complicated<sp/>rules<sp/>for<sp/>which<sp/>machines<sp/>can</highlight></codeline>
<codeline lineno="42"><highlight class="comment">#<sp/>&quot;see&quot;<sp/>which<sp/>events.<sp/>(As<sp/>a<sp/>rule<sp/>of<sp/>thumb,<sp/>if<sp/>a<sp/>machine<sp/>&quot;sees&quot;<sp/>an<sp/>event,<sp/>this</highlight></codeline>
<codeline lineno="43"><highlight class="comment">#<sp/>means<sp/>two<sp/>things:<sp/>the<sp/>event<sp/>can<sp/>affect<sp/>the<sp/>machine,<sp/>and<sp/>if<sp/>the<sp/>machine<sp/>is</highlight></codeline>
<codeline lineno="44"><highlight class="comment">#<sp/>not<sp/>in<sp/>a<sp/>state<sp/>where<sp/>it<sp/>expects<sp/>that<sp/>event<sp/>then<sp/>it&apos;s<sp/>an<sp/>error.)<sp/>These<sp/>rules</highlight></codeline>
<codeline lineno="45"><highlight class="comment">#<sp/>are:</highlight></codeline>
<codeline lineno="46"><highlight class="comment">#</highlight></codeline>
<codeline lineno="47"><highlight class="comment">#<sp/>1)<sp/>The<sp/>client<sp/>machine<sp/>sees<sp/>all<sp/>h11.events<sp/>objects<sp/>emitted<sp/>by<sp/>the<sp/>client.</highlight></codeline>
<codeline lineno="48"><highlight class="comment">#</highlight></codeline>
<codeline lineno="49"><highlight class="comment">#<sp/>2)<sp/>The<sp/>server<sp/>machine<sp/>sees<sp/>all<sp/>h11.events<sp/>objects<sp/>emitted<sp/>by<sp/>the<sp/>server.</highlight></codeline>
<codeline lineno="50"><highlight class="comment">#</highlight></codeline>
<codeline lineno="51"><highlight class="comment">#<sp/><sp/><sp/><sp/>It<sp/>also<sp/>sees<sp/>the<sp/>client&apos;s<sp/>Request<sp/>event.</highlight></codeline>
<codeline lineno="52"><highlight class="comment">#</highlight></codeline>
<codeline lineno="53"><highlight class="comment">#<sp/><sp/><sp/><sp/>And<sp/>sometimes,<sp/>server<sp/>events<sp/>are<sp/>annotated<sp/>with<sp/>a<sp/>_SWITCH_*<sp/>event.<sp/>For</highlight></codeline>
<codeline lineno="54"><highlight class="comment">#<sp/><sp/><sp/><sp/>example,<sp/>we<sp/>can<sp/>have<sp/>a<sp/>(Response,<sp/>_SWITCH_CONNECT)<sp/>event,<sp/>which<sp/>is</highlight></codeline>
<codeline lineno="55"><highlight class="comment">#<sp/><sp/><sp/><sp/>different<sp/>from<sp/>a<sp/>regular<sp/>Response<sp/>event.</highlight></codeline>
<codeline lineno="56"><highlight class="comment">#</highlight></codeline>
<codeline lineno="57"><highlight class="comment">#<sp/>3)<sp/>The<sp/>keep-alive<sp/>machine<sp/>sees<sp/>the<sp/>process_keep_alive_disabled()<sp/>event</highlight></codeline>
<codeline lineno="58"><highlight class="comment">#<sp/><sp/><sp/><sp/>(which<sp/>is<sp/>derived<sp/>from<sp/>Request/Response<sp/>events),<sp/>and<sp/>this<sp/>event</highlight></codeline>
<codeline lineno="59"><highlight class="comment">#<sp/><sp/><sp/><sp/>transitions<sp/>it<sp/>from<sp/>True<sp/>-&gt;<sp/>False,<sp/>or<sp/>from<sp/>False<sp/>-&gt;<sp/>False.<sp/>There&apos;s<sp/>no<sp/>way</highlight></codeline>
<codeline lineno="60"><highlight class="comment">#<sp/><sp/><sp/><sp/>to<sp/>transition<sp/>back.</highlight></codeline>
<codeline lineno="61"><highlight class="comment">#</highlight></codeline>
<codeline lineno="62"><highlight class="comment">#<sp/>4&amp;5)<sp/>The<sp/>_SWITCH_*<sp/>machines<sp/>transition<sp/>from<sp/>False-&gt;True<sp/>when<sp/>we<sp/>get<sp/>a</highlight></codeline>
<codeline lineno="63"><highlight class="comment">#<sp/><sp/><sp/><sp/>Request<sp/>that<sp/>proposes<sp/>the<sp/>relevant<sp/>type<sp/>of<sp/>switch<sp/>(via</highlight></codeline>
<codeline lineno="64"><highlight class="comment">#<sp/><sp/><sp/><sp/>process_client_switch_proposals),<sp/>and<sp/>they<sp/>go<sp/>from<sp/>True-&gt;False<sp/>when<sp/>we</highlight></codeline>
<codeline lineno="65"><highlight class="comment">#<sp/><sp/><sp/><sp/>get<sp/>a<sp/>Response<sp/>that<sp/>has<sp/>no<sp/>_SWITCH_*<sp/>annotation.</highlight></codeline>
<codeline lineno="66"><highlight class="comment">#</highlight></codeline>
<codeline lineno="67"><highlight class="comment">#<sp/>So<sp/>that&apos;s<sp/>event-triggered<sp/>transitions.</highlight></codeline>
<codeline lineno="68"><highlight class="comment">#</highlight></codeline>
<codeline lineno="69"><highlight class="comment">#<sp/>State-triggered<sp/>transitions<sp/>are<sp/>less<sp/>standard.<sp/>What<sp/>they<sp/>do<sp/>here<sp/>is<sp/>couple</highlight></codeline>
<codeline lineno="70"><highlight class="comment">#<sp/>the<sp/>machines<sp/>together.<sp/>The<sp/>way<sp/>this<sp/>works<sp/>is,<sp/>when<sp/>certain<sp/>*joint*</highlight></codeline>
<codeline lineno="71"><highlight class="comment">#<sp/>configurations<sp/>of<sp/>states<sp/>are<sp/>achieved,<sp/>then<sp/>we<sp/>automatically<sp/>transition<sp/>to<sp/>a</highlight></codeline>
<codeline lineno="72"><highlight class="comment">#<sp/>new<sp/>*joint*<sp/>state.<sp/>So,<sp/>for<sp/>example,<sp/>if<sp/>we&apos;re<sp/>ever<sp/>in<sp/>a<sp/>joint<sp/>state<sp/>with</highlight></codeline>
<codeline lineno="73"><highlight class="comment">#</highlight></codeline>
<codeline lineno="74"><highlight class="comment">#<sp/><sp/><sp/>client:<sp/>DONE</highlight></codeline>
<codeline lineno="75"><highlight class="comment">#<sp/><sp/><sp/>keep-alive:<sp/>False</highlight></codeline>
<codeline lineno="76"><highlight class="comment">#</highlight></codeline>
<codeline lineno="77"><highlight class="comment">#<sp/>then<sp/>the<sp/>client<sp/>state<sp/>immediately<sp/>transitions<sp/>to:</highlight></codeline>
<codeline lineno="78"><highlight class="comment">#</highlight></codeline>
<codeline lineno="79"><highlight class="comment">#<sp/><sp/><sp/>client:<sp/>MUST_CLOSE</highlight></codeline>
<codeline lineno="80"><highlight class="comment">#</highlight></codeline>
<codeline lineno="81"><highlight class="comment">#<sp/>This<sp/>is<sp/>fundamentally<sp/>different<sp/>from<sp/>an<sp/>event-based<sp/>transition,<sp/>because<sp/>it</highlight></codeline>
<codeline lineno="82"><highlight class="comment">#<sp/>doesn&apos;t<sp/>matter<sp/>how<sp/>we<sp/>arrived<sp/>at<sp/>the<sp/>{client:<sp/>DONE,<sp/>keep-alive:<sp/>False}<sp/>state</highlight></codeline>
<codeline lineno="83"><highlight class="comment">#<sp/>--<sp/>maybe<sp/>the<sp/>client<sp/>transitioned<sp/>SEND_BODY<sp/>-&gt;<sp/>DONE,<sp/>or<sp/>keep-alive</highlight></codeline>
<codeline lineno="84"><highlight class="comment">#<sp/>transitioned<sp/>True<sp/>-&gt;<sp/>False.<sp/>Either<sp/>way,<sp/>once<sp/>this<sp/>precondition<sp/>is<sp/>satisfied,</highlight></codeline>
<codeline lineno="85"><highlight class="comment">#<sp/>this<sp/>transition<sp/>is<sp/>immediately<sp/>triggered.</highlight></codeline>
<codeline lineno="86"><highlight class="comment">#</highlight></codeline>
<codeline lineno="87"><highlight class="comment">#<sp/>What<sp/>if<sp/>two<sp/>conflicting<sp/>state-based<sp/>transitions<sp/>get<sp/>enabled<sp/>at<sp/>the<sp/>same</highlight></codeline>
<codeline lineno="88"><highlight class="comment">#<sp/>time?<sp/><sp/>In<sp/>practice<sp/>there&apos;s<sp/>only<sp/>one<sp/>case<sp/>where<sp/>this<sp/>arises<sp/>(client<sp/>DONE<sp/>-&gt;</highlight></codeline>
<codeline lineno="89"><highlight class="comment">#<sp/>MIGHT_SWITCH_PROTOCOL<sp/>versus<sp/>DONE<sp/>-&gt;<sp/>MUST_CLOSE),<sp/>and<sp/>we<sp/>resolve<sp/>it<sp/>by</highlight></codeline>
<codeline lineno="90"><highlight class="comment">#<sp/>explicitly<sp/>prioritizing<sp/>the<sp/>DONE<sp/>-&gt;<sp/>MIGHT_SWITCH_PROTOCOL<sp/>transition.</highlight></codeline>
<codeline lineno="91"><highlight class="comment">#</highlight></codeline>
<codeline lineno="92"><highlight class="comment">#<sp/>Implementation</highlight></codeline>
<codeline lineno="93"><highlight class="comment">#<sp/>--------------</highlight></codeline>
<codeline lineno="94"><highlight class="comment">#</highlight></codeline>
<codeline lineno="95"><highlight class="comment">#<sp/>The<sp/>event-triggered<sp/>transitions<sp/>for<sp/>the<sp/>server<sp/>and<sp/>client<sp/>machines<sp/>are<sp/>all</highlight></codeline>
<codeline lineno="96"><highlight class="comment">#<sp/>stored<sp/>explicitly<sp/>in<sp/>a<sp/>table.<sp/>Ditto<sp/>for<sp/>the<sp/>state-triggered<sp/>transitions<sp/>that</highlight></codeline>
<codeline lineno="97"><highlight class="comment">#<sp/>involve<sp/>just<sp/>the<sp/>server<sp/>and<sp/>client<sp/>state.</highlight></codeline>
<codeline lineno="98"><highlight class="comment">#</highlight></codeline>
<codeline lineno="99"><highlight class="comment">#<sp/>The<sp/>transitions<sp/>for<sp/>the<sp/>other<sp/>machines,<sp/>and<sp/>the<sp/>state-triggered<sp/>transitions</highlight></codeline>
<codeline lineno="100"><highlight class="comment">#<sp/>that<sp/>involve<sp/>the<sp/>other<sp/>machines,<sp/>are<sp/>written<sp/>out<sp/>as<sp/>explicit<sp/>Python<sp/>code.</highlight></codeline>
<codeline lineno="101"><highlight class="comment">#</highlight></codeline>
<codeline lineno="102"><highlight class="comment">#<sp/>It&apos;d<sp/>be<sp/>nice<sp/>if<sp/>there<sp/>were<sp/>some<sp/>cleaner<sp/>way<sp/>to<sp/>do<sp/>all<sp/>this.<sp/>This<sp/>isn&apos;t</highlight></codeline>
<codeline lineno="103"><highlight class="comment">#<sp/>*too*<sp/>terrible,<sp/>but<sp/>I<sp/>feel<sp/>like<sp/>it<sp/>could<sp/>probably<sp/>be<sp/>better.</highlight></codeline>
<codeline lineno="104"><highlight class="comment">#</highlight></codeline>
<codeline lineno="105"><highlight class="comment">#<sp/>WARNING</highlight></codeline>
<codeline lineno="106"><highlight class="comment">#<sp/>-------</highlight></codeline>
<codeline lineno="107"><highlight class="comment">#</highlight></codeline>
<codeline lineno="108"><highlight class="comment">#<sp/>The<sp/>script<sp/>that<sp/>generates<sp/>the<sp/>state<sp/>machine<sp/>diagrams<sp/>for<sp/>the<sp/>docs<sp/>knows<sp/>how</highlight></codeline>
<codeline lineno="109"><highlight class="comment">#<sp/>to<sp/>read<sp/>out<sp/>the<sp/>EVENT_TRIGGERED_TRANSITIONS<sp/>and<sp/>STATE_TRIGGERED_TRANSITIONS</highlight></codeline>
<codeline lineno="110"><highlight class="comment">#<sp/>tables.<sp/>But<sp/>it<sp/>can&apos;t<sp/>automatically<sp/>read<sp/>the<sp/>transitions<sp/>that<sp/>are<sp/>written</highlight></codeline>
<codeline lineno="111"><highlight class="comment">#<sp/>directly<sp/>in<sp/>Python<sp/>code.<sp/>So<sp/>if<sp/>you<sp/>touch<sp/>those,<sp/>you<sp/>need<sp/>to<sp/>also<sp/>update<sp/>the</highlight></codeline>
<codeline lineno="112"><highlight class="comment">#<sp/>script<sp/>to<sp/>keep<sp/>it<sp/>in<sp/>sync!</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>typing<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>cast,<sp/>Dict,<sp/>Optional,<sp/>Set,<sp/>Tuple,<sp/>Type,<sp/>Union</highlight></codeline>
<codeline lineno="114"><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>._events<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>*</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>._util<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>LocalProtocolError,<sp/>Sentinel</highlight></codeline>
<codeline lineno="117"><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Everything<sp/>in<sp/>__all__<sp/>gets<sp/>re-exported<sp/>as<sp/>part<sp/>of<sp/>the<sp/>h11<sp/>public<sp/>API.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="119"><highlight class="normal">__all__<sp/>=<sp/>[</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;CLIENT&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;SERVER&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;IDLE&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;SEND_RESPONSE&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;SEND_BODY&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;DONE&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;MUST_CLOSE&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;CLOSED&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;MIGHT_SWITCH_PROTOCOL&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;SWITCHED_PROTOCOL&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;ERROR&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="131"><highlight class="normal">]</highlight></codeline>
<codeline lineno="132"><highlight class="normal"></highlight></codeline>
<codeline lineno="133"><highlight class="normal"></highlight></codeline>
<codeline lineno="134" refid="classh11_1_1__state_1_1_c_l_i_e_n_t" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_c_l_i_e_n_t" kindref="compound">CLIENT</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"></highlight></codeline>
<codeline lineno="138" refid="classh11_1_1__state_1_1_s_e_r_v_e_r" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_s_e_r_v_e_r" kindref="compound">SERVER</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="140"><highlight class="normal"></highlight></codeline>
<codeline lineno="141"><highlight class="normal"></highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight><highlight class="comment">#<sp/>States</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="143" refid="classh11_1_1__state_1_1_i_d_l_e" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_i_d_l_e" kindref="compound">IDLE</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight></codeline>
<codeline lineno="147" refid="classh11_1_1__state_1_1_s_e_n_d___r_e_s_p_o_n_s_e" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_s_e_n_d___r_e_s_p_o_n_s_e" kindref="compound">SEND_RESPONSE</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"></highlight></codeline>
<codeline lineno="151" refid="classh11_1_1__state_1_1_s_e_n_d___b_o_d_y" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_s_e_n_d___b_o_d_y" kindref="compound">SEND_BODY</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"></highlight></codeline>
<codeline lineno="155" refid="classh11_1_1__state_1_1_d_o_n_e" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_d_o_n_e" kindref="compound">DONE</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"></highlight></codeline>
<codeline lineno="158"><highlight class="normal"></highlight></codeline>
<codeline lineno="159" refid="classh11_1_1__state_1_1_m_u_s_t___c_l_o_s_e" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_m_u_s_t___c_l_o_s_e" kindref="compound">MUST_CLOSE</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"></highlight></codeline>
<codeline lineno="163" refid="classh11_1_1__state_1_1_c_l_o_s_e_d" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_c_l_o_s_e_d" kindref="compound">CLOSED</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="165"><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight></codeline>
<codeline lineno="167" refid="classh11_1_1__state_1_1_e_r_r_o_r" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_e_r_r_o_r" kindref="compound">ERROR</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"></highlight></codeline>
<codeline lineno="170"><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Switch<sp/>types</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="172" refid="classh11_1_1__state_1_1_m_i_g_h_t___s_w_i_t_c_h___p_r_o_t_o_c_o_l" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_m_i_g_h_t___s_w_i_t_c_h___p_r_o_t_o_c_o_l" kindref="compound">MIGHT_SWITCH_PROTOCOL</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"></highlight></codeline>
<codeline lineno="176" refid="classh11_1_1__state_1_1_s_w_i_t_c_h_e_d___p_r_o_t_o_c_o_l" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_s_w_i_t_c_h_e_d___p_r_o_t_o_c_o_l" kindref="compound">SWITCHED_PROTOCOL</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"></highlight></codeline>
<codeline lineno="180" refid="classh11_1_1__state_1_1___s_w_i_t_c_h___u_p_g_r_a_d_e" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1___s_w_i_t_c_h___u_p_g_r_a_d_e" kindref="compound">_SWITCH_UPGRADE</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="182"><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight></codeline>
<codeline lineno="184" refid="classh11_1_1__state_1_1___s_w_i_t_c_h___c_o_n_n_e_c_t" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1___s_w_i_t_c_h___c_o_n_n_e_c_t" kindref="compound">_SWITCH_CONNECT</ref>(<ref refid="classh11_1_1__util_1_1_sentinel" kindref="compound">Sentinel</ref>,<sp/>metaclass=Sentinel):</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">pass</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="186"><highlight class="normal"></highlight></codeline>
<codeline lineno="187"><highlight class="normal"></highlight></codeline>
<codeline lineno="188" refid="namespaceh11_1_1__state_1a4ab7e53579e38052ef854e332bdd262c" refkind="member"><highlight class="normal">EventTransitionType<sp/>=<sp/>Dict[</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/>Type[Sentinel],</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/>Dict[</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Type[Sentinel],</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Dict[Union[Type[Event],<sp/>Tuple[Type[Event],<sp/>Type[Sentinel]]],<sp/>Type[Sentinel]],</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/>],</highlight></codeline>
<codeline lineno="194"><highlight class="normal">]</highlight></codeline>
<codeline lineno="195"><highlight class="normal"></highlight></codeline>
<codeline lineno="196" refid="namespaceh11_1_1__state_1a9623076f0ca5b9bd24c4715b911d14bd" refkind="member"><highlight class="normal">EVENT_TRIGGERED_TRANSITIONS:<sp/>EventTransitionType<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/>CLIENT:<sp/>{</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>IDLE:<sp/>{Request:<sp/>SEND_BODY,<sp/>ConnectionClosed:<sp/>CLOSED},</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SEND_BODY:<sp/>{Data:<sp/>SEND_BODY,<sp/>EndOfMessage:<sp/>DONE},</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DONE:<sp/>{ConnectionClosed:<sp/>CLOSED},</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MUST_CLOSE:<sp/>{ConnectionClosed:<sp/>CLOSED},</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CLOSED:<sp/>{ConnectionClosed:<sp/>CLOSED},</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MIGHT_SWITCH_PROTOCOL:<sp/>{},</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SWITCHED_PROTOCOL:<sp/>{},</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ERROR:<sp/>{},</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/>SERVER:<sp/>{</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>IDLE:<sp/>{</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ConnectionClosed:<sp/>CLOSED,</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Response:<sp/>SEND_BODY,</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Special<sp/>case:<sp/>server<sp/>sees<sp/>client<sp/>Request<sp/>events,<sp/>in<sp/>this<sp/>form</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(Request,<sp/>CLIENT):<sp/>SEND_RESPONSE,</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SEND_RESPONSE:<sp/>{</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>InformationalResponse:<sp/>SEND_RESPONSE,</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Response:<sp/>SEND_BODY,</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(InformationalResponse,<sp/>_SWITCH_UPGRADE):<sp/>SWITCHED_PROTOCOL,</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(Response,<sp/>_SWITCH_CONNECT):<sp/>SWITCHED_PROTOCOL,</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SEND_BODY:<sp/>{Data:<sp/>SEND_BODY,<sp/>EndOfMessage:<sp/>DONE},</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DONE:<sp/>{ConnectionClosed:<sp/>CLOSED},</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MUST_CLOSE:<sp/>{ConnectionClosed:<sp/>CLOSED},</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>CLOSED:<sp/>{ConnectionClosed:<sp/>CLOSED},</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SWITCHED_PROTOCOL:<sp/>{},</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ERROR:<sp/>{},</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/>},</highlight></codeline>
<codeline lineno="227"><highlight class="normal">}</highlight></codeline>
<codeline lineno="228"><highlight class="normal"></highlight></codeline>
<codeline lineno="229" refid="namespaceh11_1_1__state_1ac18d97b374e17f831c94f47e2bb108df" refkind="member"><highlight class="normal">StateTransitionType<sp/>=<sp/>Dict[</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/>Tuple[Type[Sentinel],<sp/>Type[Sentinel]],<sp/>Dict[Type[Sentinel],<sp/>Type[Sentinel]]</highlight></codeline>
<codeline lineno="231"><highlight class="normal">]</highlight></codeline>
<codeline lineno="232"><highlight class="normal"></highlight></codeline>
<codeline lineno="233"><highlight class="normal"></highlight><highlight class="comment">#<sp/>NB:<sp/>there<sp/>are<sp/>also<sp/>some<sp/>special-case<sp/>state-triggered<sp/>transitions<sp/>hard-coded</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"></highlight><highlight class="comment">#<sp/>into<sp/>_fire_state_triggered_transitions<sp/>below.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="235" refid="namespaceh11_1_1__state_1af16fdae267955c57a8834f57dd671aa4" refkind="member"><highlight class="normal">STATE_TRIGGERED_TRANSITIONS:<sp/>StateTransitionType<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>(Client<sp/>state,<sp/>Server<sp/>state)<sp/>-&gt;<sp/>new<sp/>states</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Protocol<sp/>negotiation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/>(MIGHT_SWITCH_PROTOCOL,<sp/>SWITCHED_PROTOCOL):<sp/>{CLIENT:<sp/>SWITCHED_PROTOCOL},</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Socket<sp/>shutdown</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/>(CLOSED,<sp/>DONE):<sp/>{SERVER:<sp/>MUST_CLOSE},</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/>(CLOSED,<sp/>IDLE):<sp/>{SERVER:<sp/>MUST_CLOSE},</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/>(ERROR,<sp/>DONE):<sp/>{SERVER:<sp/>MUST_CLOSE},</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/>(DONE,<sp/>CLOSED):<sp/>{CLIENT:<sp/>MUST_CLOSE},</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/>(IDLE,<sp/>CLOSED):<sp/>{CLIENT:<sp/>MUST_CLOSE},</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/><sp/><sp/>(DONE,<sp/>ERROR):<sp/>{CLIENT:<sp/>MUST_CLOSE},</highlight></codeline>
<codeline lineno="246"><highlight class="normal">}</highlight></codeline>
<codeline lineno="247"><highlight class="normal"></highlight></codeline>
<codeline lineno="248"><highlight class="normal"></highlight></codeline>
<codeline lineno="249" refid="classh11_1_1__state_1_1_connection_state" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state" kindref="compound">ConnectionState</ref>:</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal">__init__(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Extra<sp/>bits<sp/>of<sp/>state<sp/>that<sp/>don&apos;t<sp/>quite<sp/>fit<sp/>into<sp/>the<sp/>state<sp/>model.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"></highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>If<sp/>this<sp/>is<sp/>False<sp/>then<sp/>it<sp/>enables<sp/>the<sp/>automatic<sp/>DONE<sp/>-&gt;<sp/>MUST_CLOSE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>transition.<sp/>Don&apos;t<sp/>set<sp/>this<sp/>directly;<sp/>call<sp/>.keep_alive_disabled()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="255" refid="classh11_1_1__state_1_1_connection_state_1a53633c17a6834c8d34a42540b30c0a73" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a53633c17a6834c8d34a42540b30c0a73" kindref="member">keep_alive</ref><sp/>=<sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"></highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>This<sp/>is<sp/>a<sp/>subset<sp/>of<sp/>{UPGRADE,<sp/>CONNECT},<sp/>containing<sp/>the<sp/>proposals</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>made<sp/>by<sp/>the<sp/>client<sp/>for<sp/>switching<sp/>protocols.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="259" refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" kindref="member">pending_switch_proposals</ref>:<sp/>Set[Type[Sentinel]]<sp/>=<sp/>set()</highlight></codeline>
<codeline lineno="260"><highlight class="normal"></highlight></codeline>
<codeline lineno="261" refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>:<sp/>Dict[Type[Sentinel],<sp/>Type[Sentinel]]<sp/>=<sp/>{CLIENT:<sp/>IDLE,<sp/>SERVER:<sp/>IDLE}</highlight></codeline>
<codeline lineno="262"><highlight class="normal"></highlight></codeline>
<codeline lineno="263" refid="classh11_1_1__state_1_1_connection_state_1a61d061f694ee36ef66d6b906f1462d91" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state_1a61d061f694ee36ef66d6b906f1462d91" kindref="member">process_error</ref>(self,<sp/>role:<sp/>Type[Sentinel])<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[role]<sp/>=<sp/>ERROR</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a841060c63a27f284a0da37c28fd28e42" kindref="member">_fire_state_triggered_transitions</ref>()</highlight></codeline>
<codeline lineno="266"><highlight class="normal"></highlight></codeline>
<codeline lineno="267" refid="classh11_1_1__state_1_1_connection_state_1a537791e35706c54c24aac941318ca8df" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state_1a537791e35706c54c24aac941318ca8df" kindref="member">process_keep_alive_disabled</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a53633c17a6834c8d34a42540b30c0a73" kindref="member">keep_alive</ref><sp/>=<sp/></highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a841060c63a27f284a0da37c28fd28e42" kindref="member">_fire_state_triggered_transitions</ref>()</highlight></codeline>
<codeline lineno="270"><highlight class="normal"></highlight></codeline>
<codeline lineno="271" refid="classh11_1_1__state_1_1_connection_state_1ae287cab58e535e272b333af4af0d3f43" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state_1ae287cab58e535e272b333af4af0d3f43" kindref="member">process_client_switch_proposal</ref>(self,<sp/>switch_event:<sp/>Type[Sentinel])<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" kindref="member">pending_switch_proposals</ref>.add(switch_event)</highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a841060c63a27f284a0da37c28fd28e42" kindref="member">_fire_state_triggered_transitions</ref>()</highlight></codeline>
<codeline lineno="274"><highlight class="normal"></highlight></codeline>
<codeline lineno="275" refid="classh11_1_1__state_1_1_connection_state_1ab43b5c5b724869ad5c8b67234e71128c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state_1ab43b5c5b724869ad5c8b67234e71128c" kindref="member">process_event</ref>(</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>role:<sp/>Type[Sentinel],</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>event_type:<sp/>Type[Event],</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>server_switch_event:<sp/>Optional[Type[Sentinel]]<sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_event_type:<sp/>Union[Type[Event],<sp/>Tuple[Type[Event],<sp/>Type[Sentinel]]]<sp/>=<sp/>event_type</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>server_switch_event<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">assert</highlight><highlight class="normal"><sp/>role<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/>SERVER</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>server_switch_event<sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" kindref="member">pending_switch_proposals</ref>:</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/><ref refid="classh11_1_1__util_1_1_local_protocol_error" kindref="compound">LocalProtocolError</ref>(</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;Received<sp/>server<sp/>_SWITCH_UPGRADE<sp/>event<sp/>without<sp/>a<sp/>pending<sp/>proposal&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_event_type<sp/>=<sp/>(event_type,<sp/>server_switch_event)</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>server_switch_event<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>_event_type<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/>Response:</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" kindref="member">pending_switch_proposals</ref><sp/>=<sp/>set()</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1aee366ace5e1ccb1a21229254d0853bdc" kindref="member">_fire_event_triggered_transitions</ref>(role,<sp/>_event_type)</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Special<sp/>case:<sp/>the<sp/>server<sp/>state<sp/>does<sp/>get<sp/>to<sp/>see<sp/>Request</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>events.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>_event_type<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/>Request:</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">assert</highlight><highlight class="normal"><sp/>role<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/>CLIENT</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1aee366ace5e1ccb1a21229254d0853bdc" kindref="member">_fire_event_triggered_transitions</ref>(SERVER,<sp/>(Request,<sp/>CLIENT))</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a841060c63a27f284a0da37c28fd28e42" kindref="member">_fire_state_triggered_transitions</ref>()</highlight></codeline>
<codeline lineno="298"><highlight class="normal"></highlight></codeline>
<codeline lineno="299" refid="classh11_1_1__state_1_1_connection_state_1aee366ace5e1ccb1a21229254d0853bdc" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state_1aee366ace5e1ccb1a21229254d0853bdc" kindref="member">_fire_event_triggered_transitions</ref>(</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>role:<sp/>Type[Sentinel],</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>event_type:<sp/>Union[Type[Event],<sp/>Tuple[Type[Event],<sp/>Type[Sentinel]]],</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>state<sp/>=<sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[role]</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_state<sp/>=<sp/>EVENT_TRIGGERED_TRANSITIONS[role][state][event_type]</highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">except</highlight><highlight class="normal"><sp/>KeyError:</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>event_type<sp/>=<sp/>cast(Type[Event],<sp/>event_type)</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/><ref refid="classh11_1_1__util_1_1_local_protocol_error" kindref="compound">LocalProtocolError</ref>(</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;can&apos;t<sp/>handle<sp/>event<sp/>type<sp/>{}<sp/>when<sp/>role={}<sp/>and<sp/>state={}&quot;</highlight><highlight class="normal">.format(</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>event_type.__name__,<sp/>role,<sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[role]</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[role]<sp/>=<sp/>new_state</highlight></codeline>
<codeline lineno="315"><highlight class="normal"></highlight></codeline>
<codeline lineno="316" refid="classh11_1_1__state_1_1_connection_state_1a841060c63a27f284a0da37c28fd28e42" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state_1a841060c63a27f284a0da37c28fd28e42" kindref="member">_fire_state_triggered_transitions</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>We<sp/>apply<sp/>these<sp/>rules<sp/>repeatedly<sp/>until<sp/>converging<sp/>on<sp/>a<sp/>fixed<sp/>point</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">True</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_states<sp/>=<sp/>dict(self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>)</highlight></codeline>
<codeline lineno="320"><highlight class="normal"></highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>It<sp/>could<sp/>happen<sp/>that<sp/>both<sp/>these<sp/>special-case<sp/>transitions<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>enabled<sp/>at<sp/>the<sp/>same<sp/>time:</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/>DONE<sp/>-&gt;<sp/>MIGHT_SWITCH_PROTOCOL</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/>DONE<sp/>-&gt;<sp/>MUST_CLOSE</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>For<sp/>example,<sp/>this<sp/>will<sp/>always<sp/>be<sp/>true<sp/>of<sp/>a<sp/>HTTP/1.0<sp/>client</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>requesting<sp/>CONNECT.<sp/><sp/>If<sp/>this<sp/>happens,<sp/>the<sp/>protocol<sp/>switch<sp/>takes</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>priority.<sp/>From<sp/>there<sp/>the<sp/>client<sp/>will<sp/>either<sp/>go<sp/>to</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>SWITCHED_PROTOCOL,<sp/>in<sp/>which<sp/>case<sp/>it&apos;s<sp/>none<sp/>of<sp/>our<sp/>business<sp/>when</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>they<sp/>close<sp/>the<sp/>connection,<sp/>or<sp/>else<sp/>the<sp/>server<sp/>will<sp/>deny<sp/>the</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>request,<sp/>in<sp/>which<sp/>case<sp/>the<sp/>client<sp/>will<sp/>go<sp/>back<sp/>to<sp/>DONE<sp/>and<sp/>then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>from<sp/>there<sp/>to<sp/>MUST_CLOSE.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" kindref="member">pending_switch_proposals</ref>:</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[CLIENT]<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/>DONE:</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[CLIENT]<sp/>=<sp/>MIGHT_SWITCH_PROTOCOL</highlight></codeline>
<codeline lineno="337"><highlight class="normal"></highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" kindref="member">pending_switch_proposals</ref>:</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[CLIENT]<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/>MIGHT_SWITCH_PROTOCOL:</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[CLIENT]<sp/>=<sp/>DONE</highlight></codeline>
<codeline lineno="341"><highlight class="normal"></highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a53633c17a6834c8d34a42540b30c0a73" kindref="member">keep_alive</ref>:</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>role<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>(CLIENT,<sp/>SERVER):</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[role]<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/>DONE:</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[role]<sp/>=<sp/>MUST_CLOSE</highlight></codeline>
<codeline lineno="346"><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Tabular<sp/>state-triggered<sp/>transitions</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>joint_state<sp/>=<sp/>(self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[CLIENT],<sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>[SERVER])</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>changes<sp/>=<sp/>STATE_TRIGGERED_TRANSITIONS.get(joint_state,<sp/>{})</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref>.update(changes)</highlight></codeline>
<codeline lineno="351"><highlight class="normal"></highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref><sp/>==<sp/>start_states:</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Fixed<sp/>point<sp/>reached</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="355"><highlight class="normal"></highlight></codeline>
<codeline lineno="356" refid="classh11_1_1__state_1_1_connection_state_1a7a1097243a7fdbc20328ad701ea3c098" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classh11_1_1__state_1_1_connection_state_1a7a1097243a7fdbc20328ad701ea3c098" kindref="member">start_next_cycle</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref><sp/>!=<sp/>{CLIENT:<sp/>DONE,<sp/>SERVER:<sp/>DONE}:</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/><ref refid="classh11_1_1__util_1_1_local_protocol_error" kindref="compound">LocalProtocolError</ref>(</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;not<sp/>in<sp/>a<sp/>reusable<sp/>state.<sp/>self.states={self.states}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Can&apos;t<sp/>reach<sp/>DONE/DONE<sp/>with<sp/>any<sp/>of<sp/>these<sp/>active,<sp/>but<sp/>still,<sp/>let&apos;s<sp/>be</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>sure.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">assert</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a53633c17a6834c8d34a42540b30c0a73" kindref="member">keep_alive</ref></highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">assert</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1a77640318f95267b77bbb24617299044b" kindref="member">pending_switch_proposals</ref></highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classh11_1_1__state_1_1_connection_state_1afd013b4015add0ff9b023a52ac8c6808" kindref="member">states</ref><sp/>=<sp/>{CLIENT:<sp/>IDLE,<sp/>SERVER:<sp/>IDLE}</highlight></codeline>
    </programlisting>
    <location file="micro_gestion_objetos/venv/Lib/site-packages/h11/_state.py"/>
  </compounddef>
</doxygen>
