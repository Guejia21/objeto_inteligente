\doxysection{mqtt\+\_\+adapter.\+py}
\hypertarget{mqtt__adapter_8py_source}{}\label{mqtt__adapter_8py_source}\index{microservicio\_data\_stream/broker/mqtt\_adapter.py@{microservicio\_data\_stream/broker/mqtt\_adapter.py}}
\mbox{\hyperlink{mqtt__adapter_8py}{Ir a la documentación de este archivo.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00001}\mbox{\hyperlink{namespacemqtt__adapter}{00001}}\ \textcolor{stringliteral}{"{}"{}"{}Adapter\ para\ el\ broker\ MQTT"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00002}00002\ \textcolor{keyword}{import}\ asyncio}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00003}00003\ \textcolor{keyword}{from}\ broker.broker\_interface\ \textcolor{keyword}{import}\ BrokerInterface}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00004}00004\ \textcolor{keyword}{from}\ lib.umqtt.simple\ \textcolor{keyword}{import}\ MQTTClient}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00005}00005\ }
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00006}\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter}{00006}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter}{MQTTAdapter}}(BrokerInterface):}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00007}00007\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self,\ client\_id,\ broker,\ user=None,\ password=None,\ port=1883):}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00008}\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_ade19f37df7471959366ec8efad55f3a2}{00008}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_ade19f37df7471959366ec8efad55f3a2}{client}}\ =\ MQTTClient(client\_id,\ broker,\ user=user,\ password=password,\ port=port)}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00009}\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{00009}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00011}00011\ \ \ \ \ \textcolor{keyword}{def\ }\_\_conectar(self):}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00012}00012\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00013}00013\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_ade19f37df7471959366ec8efad55f3a2}{client}}.connect()}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00014}00014\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00015}00015\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}Conectado\ al\ broker\ MQTT"{}})}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00016}00016\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00017}00017\ \ \ \ \ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{"{}Error\ conectando\ a\ MQTT:\ \{e\}"{}})}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00018}00018\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00019}00019\ }
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00020}\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_a37a5345f57e073fa51f057770bec2ebf}{00020}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_a37a5345f57e073fa51f057770bec2ebf}{publicar}}(self,\ topico,\ mensaje):}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00021}00021\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00022}00022\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter}{\_\_conectar}}()}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00023}00023\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00024}00024\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00025}00025\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_ade19f37df7471959366ec8efad55f3a2}{client}}.publish(topico.encode(),\ mensaje.encode())\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00026}00026\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00027}00027\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{"{}Error\ publicando\ en\ MQTT:\ \{e\}"{}})}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00028}00028\ }
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00029}\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_a3ed3c00e87dbc58b7a47372f3035c5d0}{00029}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_a3ed3c00e87dbc58b7a47372f3035c5d0}{suscribirse}}(self,\ topico,\ callback):}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Intentar\ conectar\ sin\ bloquear\ indefinidamente}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{"{}Intentando\ conectar\ a\ MQTT\ broker..."{}})}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00033}00033\ \ \ \ \ \ \ \ \ \ \ \ \ await\ asyncio.sleep(0)\ \ \textcolor{comment}{\#\ Yield\ control}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter}{\_\_conectar}}()}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00035}00035\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00036}00036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}Reintentando\ en\ 5\ segundos..."{}})}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ asyncio.sleep(5)\ \ \textcolor{comment}{\#\ Espera\ asíncrona\ entre\ reintentos}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00038}00038\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00039}00039\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_ade19f37df7471959366ec8efad55f3a2}{client}}.set\_callback(callback)}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00040}00040\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_ade19f37df7471959366ec8efad55f3a2}{client}}.subscribe(topico.encode())}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00041}00041\ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{"{}Suscrito\ al\ tópico:\ \{topico\}"{}})}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keyword}{True}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00045}00045\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00046}00046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_ade19f37df7471959366ec8efad55f3a2}{client}}.check\_msg()\ \ \textcolor{comment}{\#\ No\ bloqueante}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(f\textcolor{stringliteral}{"{}Error\ en\ MQTT:\ \{e\}"{}})}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00049}00049\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classmqtt__adapter_1_1_m_q_t_t_adapter_adffe3f8b2930c7f3a9499a3b83ac1718}{conectado}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{mqtt__adapter_8py_source_l00050}00050\ \ \ \ \ \ \ \ \ \ \ \ \ await\ asyncio.sleep(0.1)}

\end{DoxyCode}
