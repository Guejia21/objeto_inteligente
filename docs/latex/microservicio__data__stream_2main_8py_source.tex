\doxysection{main.\+py}
\hypertarget{microservicio__data__stream_2main_8py_source}{}\label{microservicio__data__stream_2main_8py_source}\index{microservicio\_data\_stream/main.py@{microservicio\_data\_stream/main.py}}
\mbox{\hyperlink{microservicio__data__stream_2main_8py}{Ir a la documentación de este archivo.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00001}00001\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00002}00002\ \textcolor{stringliteral}{\ *\ @file\ main.py}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00003}00003\ \textcolor{stringliteral}{\ *\ @brief\ Punto\ de\ entrada\ principal\ del\ Microservicio\ de\ Datastreams\ (Microdot)}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00004}00004\ \textcolor{stringliteral}{\ *\ @details}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00005}00005\ \textcolor{stringliteral}{\ *\ Servicio\ responsable\ de\ gestionar\ datastreams\ de\ objetos\ inteligentes\ usando\ Microdot\ framework\ (MicroPython).}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00006}00006\ \textcolor{stringliteral}{\ *\ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00007}00007\ \textcolor{stringliteral}{\ *\ Funcionalidades\ principales:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00008}00008\ \textcolor{stringliteral}{\ *\ -\/\ Servidor\ HTTP\ asincrónico\ basado\ en\ Microdot}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00009}00009\ \textcolor{stringliteral}{\ *\ -\/\ Gestión\ de\ datastreams\ (sensores\ y\ actuadores)}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00010}00010\ \textcolor{stringliteral}{\ *\ -\/\ Publicación\ periódica\ de\ telemetría\ a\ ThingBoard\ y\ Mosquitto}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00011}00011\ \textcolor{stringliteral}{\ *\ -\/\ Consumo\ de\ mensajes\ MQTT\ para\ inicialización\ y\ actuaciones}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00012}00012\ \textcolor{stringliteral}{\ *\ -\/\ Cierre\ seguro\ con\ manejo\ de\ señales\ UNIX}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00013}00013\ \textcolor{stringliteral}{\ *\ -\/\ Soporte\ para\ WiFi\ en\ dispositivos\ ESP32}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00014}00014\ \textcolor{stringliteral}{\ *\ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00015}00015\ \textcolor{stringliteral}{\ *\ @see\ routes/datastreams.py\ para\ definición\ de\ endpoints}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00016}00016\ \textcolor{stringliteral}{\ *\ @see\ services/datastream\_service.py\ para\ lógica\ de\ negocio}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00017}00017\ \textcolor{stringliteral}{\ *\ @see\ config.py\ para\ configuración\ del\ servicio}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00018}00018\ \textcolor{stringliteral}{\ *\ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00019}00019\ \textcolor{stringliteral}{\ *\ @author\ Sistema\ de\ Objetos\ Inteligentes}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00020}00020\ \textcolor{stringliteral}{\ *\ @version\ 1.0.0}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00021}00021\ \textcolor{stringliteral}{\ *\ @date\ 2024}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00022}00022\ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00023}00023\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00024}00024\ \textcolor{keyword}{import}\ json\ \textcolor{keyword}{as}\ json}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00025}00025\ \textcolor{keyword}{import}\ signal}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00026}00026\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacelib_1_1microdot_1_1microdot}{lib.microdot.microdot}}\ \textcolor{keyword}{import}\ Microdot}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00027}00027\ \textcolor{keyword}{from}\ broker.broker\_interface\ \textcolor{keyword}{import}\ consumer\_mqtt,\ publicar\_valores,\ tb\_publicacion\_task,\ mosq\_publicacion\_task}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00028}00028\ \textcolor{comment}{\#from\ broker.mqtt\_adapter\ import\ MQTTAdapter}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00029}00029\ \textcolor{keyword}{from}\ broker.mqtt\_python\_adapter\ \textcolor{keyword}{import}\ mosquitto\_broker,\ tb\_broker}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00030}00030\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceroutes_1_1datastreams}{routes.datastreams}}\ \textcolor{keyword}{import}\ register\_routes}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00031}00031\ \textcolor{keyword}{from}\ config\ \textcolor{keyword}{import}\ Config}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00032}00032\ \textcolor{comment}{\#import\ network\ \#Activar\ si\ se\ usa\ ESP32\ con\ WiFi}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00033}00033\ \textcolor{keyword}{import}\ asyncio}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00034}00034\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00035}00035\ \textcolor{comment}{\#\ Crear\ aplicación}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00036}00036\ app\ =\ Microdot()}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00037}00037\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00038}00038\ \textcolor{comment}{\#\ Configurar\ broker\ MQTT\ cuando\ se\ desea\ usar\ microPython}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00039}00039\ \textcolor{stringliteral}{"{}"{}"{}broker\ =\ MQTTAdapter(}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00040}00040\ \textcolor{stringliteral}{\ \ \ \ client\_id="{}datastream\_service"{},}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00041}00041\ \textcolor{stringliteral}{\ \ \ \ \#broker=Config.OBJECT\_IP,}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00042}00042\ \textcolor{stringliteral}{\ \ \ \ broker=Config.BROKER\_HOST,\ \#Usar\ localhost\ para\ pruebas\ locales}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00043}00043\ \textcolor{stringliteral}{\ \ \ \ port=Config.MQTT\_PORT}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00044}00044\ \textcolor{stringliteral}{)"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00045}00045\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00046}00046\ \textcolor{comment}{\#\ Registrar\ rutas}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00047}00047\ register\_routes(app)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00048}00048\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00049}00049\ \textcolor{comment}{\#\ Flag\ para\ controlar\ el\ cierre}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00050}\mbox{\hyperlink{namespacemain_a9d9c0f06ea285d6128fdce786fa66851}{00050}}\ shutdown\_event\ =\ asyncio.Event()}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00051}\mbox{\hyperlink{namespacemain_aa530773ea5df6edbdc7807a0eaa51773}{00051}}\ running\_tasks\ =\ []}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00053}00053\ \textcolor{comment}{\#Configuración\ de\ WiFi\ (si\ aplica)}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00054}\mbox{\hyperlink{namespacemain_a79124365d1c83d2112cc071a29831386}{00054}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacemain_a79124365d1c83d2112cc071a29831386}{conectar\_wifi}}():}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00055}00055\ \ \ \ \ wlan\ =\ network.WLAN(network.STA\_IF)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00056}00056\ \ \ \ \ wlan.active(\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00057}00057\ \ \ \ \ wlan.connect(Config.WIFI\_SSID,\ Config.WIFI\_PASS)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00058}00058\ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keywordflow}{not}\ wlan.isconnected():}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00059}00059\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{pass}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00060}00060\ \ \ \ \ print(\textcolor{stringliteral}{"{}WiFi\ conectada:"{}},\ wlan.ifconfig())}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00063}\mbox{\hyperlink{namespacemain_a799b0d523414a91d4d3924ae19ec6e0f}{00063}}\ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{namespacemain_a799b0d523414a91d4d3924ae19ec6e0f}{shutdown}}():}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00064}00064\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00065}00065\ \textcolor{stringliteral}{\ \ \ \ \ *\ @brief\ Maneja\ el\ cierre\ seguro\ del\ servidor\ Microdot}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00066}00066\ \textcolor{stringliteral}{\ \ \ \ \ *\ @details}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00067}00067\ \textcolor{stringliteral}{\ \ \ \ \ *\ Coordina\ la\ detención\ ordenada\ de:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00068}00068\ \textcolor{stringliteral}{\ \ \ \ \ *\ 1.\ Event\ loop\ -\/\ propaga\ shutdown\_event}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00069}00069\ \textcolor{stringliteral}{\ \ \ \ \ *\ 2.\ Tareas\ asyncio\ -\/\ cancela\ todas\ las\ tareas\ en\ running\_tasks}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00070}00070\ \textcolor{stringliteral}{\ \ \ \ \ *\ 3.\ Conexiones\ MQTT\ -\/\ cierra\ clientes\ mosquitto\ y\ ThingBoard}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00071}00071\ \textcolor{stringliteral}{\ \ \ \ \ *\ 4.\ Servidor\ HTTP\ -\/\ detiene\ Microdot}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00072}00072\ \textcolor{stringliteral}{\ \ \ \ \ *\ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00073}00073\ \textcolor{stringliteral}{\ \ \ \ \ *\ @return\ void}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00074}00074\ \textcolor{stringliteral}{\ \ \ \ \ *\ @see\ running\_tasks\ lista\ de\ tareas\ en\ ejecución}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00075}00075\ \textcolor{stringliteral}{\ \ \ \ \ *\ @see\ mosquitto\_broker\ cliente\ MQTT\ Mosquitto}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00076}00076\ \textcolor{stringliteral}{\ \ \ \ \ *\ @see\ tb\_broker\ cliente\ MQTT\ ThingBoard}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00077}00077\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00078}00078\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Maneja\ el\ cierre\ seguro\ del\ servidor"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00079}00079\ \textcolor{stringliteral}{\ \ \ \ print("{}\(\backslash\)nCerrando\ servidor..."{})}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00080}00080\ \textcolor{stringliteral}{\ \ \ \ shutdown\_event.set()}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00081}00081\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00082}00082\ \textcolor{stringliteral}{\ \ \ \ \#\ Cancelar\ todas\ las\ tareas}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00083}00083\ \textcolor{stringliteral}{\ \ \ \ for\ task\ in\ running\_tasks:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00084}00084\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ if\ task\ and\ not\ task.done():}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00085}00085\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ task.cancel()}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00086}00086\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ try:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00087}00087\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ task}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00088}00088\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ except\ asyncio.CancelledError:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00089}00089\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pass}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00090}00090\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00091}00091\ \textcolor{stringliteral}{\ \ \ \ \#\ Cerrar\ conexiones\ MQTT}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00092}00092\ \textcolor{stringliteral}{\ \ \ \ try:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00093}00093\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ if\ hasattr(mosquitto\_broker,\ 'client')\ and\ mosquitto\_broker.client:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00094}00094\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ mosquitto\_broker.client.loop\_stop()}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00095}00095\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ mosquitto\_broker.client.disconnect()}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00096}00096\ \textcolor{stringliteral}{\ \ \ \ except\ Exception:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00097}00097\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ pass}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00098}00098\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00099}00099\ \textcolor{stringliteral}{\ \ \ \ try:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00100}00100\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ if\ hasattr(tb\_broker,\ 'client')\ and\ tb\_broker.client:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00101}00101\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ tb\_broker.client.loop\_stop()}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00102}00102\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ tb\_broker.client.disconnect()}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00103}00103\ \textcolor{stringliteral}{\ \ \ \ except\ Exception:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00104}00104\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ pass}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00105}00105\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00106}00106\ \textcolor{stringliteral}{\ \ \ \ \#\ Detener\ servidor\ Microdot}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00107}00107\ \textcolor{stringliteral}{\ \ \ \ try:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00108}00108\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ app.shutdown()}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00109}00109\ \textcolor{stringliteral}{\ \ \ \ except\ Exception:}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00110}00110\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ pass}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00111}00111\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00112}00112\ \textcolor{stringliteral}{\ \ \ \ print("{}Servidor\ cerrado\ correctamente"{})}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00113}00113\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00114}00114\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00115}00115\ \textcolor{stringliteral}{\#\ Ejecutar\ servidor}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00116}\mbox{\hyperlink{namespacemain_a3140e9a5b6a71ffbf498198cfc471b88}{00116}}\ \textcolor{stringliteral}{async\ def\ main():}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00117}00117\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00118}00118\ \ \ \ \ \ *\ @brief\ Función\ principal\ que\ inicializa\ y\ ejecuta\ el\ servidor\ Microdot}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00119}00119\ \ \ \ \ \ *\ @details}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00120}00120\ \ \ \ \ \ *\ Secuencia\ de\ inicialización:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00121}00121\ \ \ \ \ \ *\ 1.\ Imprime\ configuración\ del\ servicio\ (HOST,\ PORT,\ OSID,\ TITLE)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00122}00122\ \ \ \ \ \ *\ 2.\ Registra\ manejadores\ de\ señales\ UNIX\ (SIGINT,\ SIGTERM)\ para\ shutdown\ seguro}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00123}00123\ \ \ \ \ \ *\ 3.\ Inicia\ servidor\ Microdot\ asincrónico}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00124}00124\ \ \ \ \ \ *\ 4.\ Si\ OSID\ está\ configurado:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00125}00125\ \ \ \ \ \ *\ \ \ \ -\/\ Publica\ telemetría\ periódicamente\ a\ ThingBoard\ (si\ token\ disponible)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00126}00126\ \ \ \ \ \ *\ \ \ \ -\/\ Publica\ telemetría\ periódicamente\ a\ Mosquitto}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00127}00127\ \ \ \ \ \ *\ 5.\ Si\ OSID\ no\ está\ configurado:\ espera\ mensajes\ MQTT\ de\ inicialización}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00128}00128\ \ \ \ \ \ *\ 6.\ Aguarda\ evento\ de\ shutdown}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00129}00129\ \ \ \ \ \ *\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00130}00130\ \ \ \ \ \ *\ @return\ void\ (async)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00131}00131\ \ \ \ \ \ *\ @see\ shutdown()\ función\ invocada\ en\ cierre}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00132}00132\ \ \ \ \ \ *\ @see\ Config\ configuración\ centralizada}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00133}00133\ \ \ \ \ \ *\ @see\ publicar\_valores\ tarea\ de\ publicación\ periódica}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00134}00134\ \ \ \ \ \ *\ @see\ consumer\_mqtt\ consumidor\ de\ mensajes\ de\ inicialización}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00135}00135\ \ \ \ \ "{}"{}"{}}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00136}00136\ \ \ \ \ print(f"{}\ \ \ Datastream\ Service\ iniciando\ en\ \{Config.HOST\}:\{Config.PORT\}"{})}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00137}00137\ \ \ \ \ print(f"{}\ \ \ OSID:\ \{Config.OSID\}"{})}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00138}00138\ \ \ \ \ print(f"{}\ \ \ Title:\ \{Config.TITLE\}"{})}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00139}00139\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00140}00140\ \ \ \ \ \#\ Configurar\ manejadores\ de\ señales\ para\ cierre\ seguro}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00141}00141\ \ \ \ \ loop\ =\ asyncio.get\_running\_loop()}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00142}00142\ \ \ \ \ for\ sig\ in\ (signal.SIGINT,\ signal.SIGTERM):}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00143}00143\ \ \ \ \ \ \ \ \ loop.add\_signal\_handler(sig,\ lambda:\ asyncio.create\_task(shutdown()))}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00144}00144\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00145}00145\ \ \ \ \ \#conectar\_wifi()}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00146}00146\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00147}00147\ \ \ \ \ \#\ Iniciar\ servidor}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00148}00148\ \ \ \ \ server\_task\ =\ asyncio.create\_task(app.start\_server(host=Config.HOST,\ port=Config.PORT))}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00149}00149\ \ \ \ \ running\_tasks.append(server\_task)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00150}00150\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00151}00151\ \ \ \ \ if\ Config.OSID:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00152}00152\ \ \ \ \ \ \ \ \ \#\ Iniciar\ publicación\ periódica\ a\ ThingBoard\ si\ ya\ hay\ OSID\ y\ token\ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00153}00153\ \ \ \ \ \ \ \ \ if\ Config.THINGSBOARD\_ACCESS\_TOKEN\ !=\ "{}"{}:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00154}00154\ \ \ \ \ \ \ \ \ \ \ \ \ global\ tb\_publicacion\_task}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ print("{}Iniciando\ publicación\ a\ ThingsBoard..."{})}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ tb\_publicacion\_task\ =\ asyncio.create\_task(}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00157}00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ publicar\_valores(tb\_broker,\ Config.OSID,\ topic=Config.THINGSBOARD\_TELEMETRY\_TOPIC,\ interval=Config.TELEMETRY\_PUBLISH\_INTERVAL)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \ \ \ running\_tasks.append(tb\_publicacion\_task)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00160}00160\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ \#\ Iniciar\ publicación\ periodica\ a\ Mosquitto\ si\ ya\ hay\ OSID}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00162}00162\ \ \ \ \ \ \ \ \ global\ mosq\_publicacion\_task}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ mosq\_publicacion\_task\ =\ asyncio.create\_task(}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ publicar\_valores(mosquitto\_broker,\ Config.OSID,\ topic=Config.MOSQUITTO\_TELEMETRY\_TOPIC,\ interval=Config.TELEMETRY\_PUBLISH\_INTERVAL)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00165}00165\ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00166}00166\ \ \ \ \ \ \ \ \ running\_tasks.append(mosq\_publicacion\_task)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00167}00167\ \ \ \ \ else:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00168}00168\ \ \ \ \ \ \ \ \ \#\ Si\ el\ objeto\ no\ está\ inicializado,\ esperar\ a\ que\ se\ inicialice}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00169}00169\ \ \ \ \ \ \ \ \ print("{}Esperando\ inicialización\ del\ objeto..."{})}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ consumer\_task\ =\ asyncio.create\_task(consumer\_mqtt(mosquitto\_broker))}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00171}00171\ \ \ \ \ \ \ \ \ running\_tasks.append(consumer\_task)}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00172}00172\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00173}00173\ \ \ \ \ \#\ Esperar\ hasta\ que\ se\ solicite\ el\ cierre}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00174}00174\ \ \ \ \ try:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00175}00175\ \ \ \ \ \ \ \ \ await\ shutdown\_event.wait()}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00176}00176\ \ \ \ \ except\ asyncio.CancelledError:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00177}00177\ \ \ \ \ \ \ \ \ pass}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00178}00178\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00179}00179\ }
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00180}00180\ if\ \_\_name\_\_\ ==\ '\_\_main\_\_':}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00181}00181\ \ \ \ \ try:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00182}00182\ \ \ \ \ \ \ \ \ asyncio.run(main())}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00183}00183\ \ \ \ \ except\ KeyboardInterrupt:}
\DoxyCodeLine{\Hypertarget{microservicio__data__stream_2main_8py_source_l00184}00184\ \ \ \ \ \ \ \ \ print("{}\(\backslash\)nServidor\ interrumpido\ por\ el\ usuario"{})}

\end{DoxyCode}
