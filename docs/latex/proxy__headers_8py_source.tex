\doxysection{proxy\+\_\+headers.\+py}
\hypertarget{proxy__headers_8py_source}{}\label{proxy__headers_8py_source}\index{micro\_gestion\_objetos/venv/Lib/site-\/packages/uvicorn/middleware/proxy\_headers.py@{micro\_gestion\_objetos/venv/Lib/site-\/packages/uvicorn/middleware/proxy\_headers.py}}
\mbox{\hyperlink{proxy__headers_8py}{Ir a la documentaci√≥n de este archivo.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00001}\mbox{\hyperlink{namespaceuvicorn_1_1middleware_1_1proxy__headers}{00001}}\ \textcolor{keyword}{from}\ \_\_future\_\_\ \textcolor{keyword}{import}\ annotations}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00003}00003\ \textcolor{keyword}{import}\ ipaddress}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00004}00004\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00005}00005\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1__types}{uvicorn.\_types}}\ \textcolor{keyword}{import}\ ASGI3Application,\ ASGIReceiveCallable,\ ASGISendCallable,\ Scope}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00008}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware}{00008}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware}{ProxyHeadersMiddleware}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00009}00009\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Middleware\ for\ handling\ known\ proxy\ headers}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00010}00010\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00011}00011\ \textcolor{stringliteral}{\ \ \ \ This\ middleware\ can\ be\ used\ when\ a\ known\ proxy\ is\ fronting\ the\ application,}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00012}00012\ \textcolor{stringliteral}{\ \ \ \ and\ is\ trusted\ to\ be\ properly\ setting\ the\ \`{}X-\/Forwarded-\/Proto\`{}\ and}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00013}00013\ \textcolor{stringliteral}{\ \ \ \ \`{}X-\/Forwarded-\/For\`{}\ headers\ with\ the\ connecting\ client\ information.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00014}00014\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00015}00015\ \textcolor{stringliteral}{\ \ \ \ Modifies\ the\ \`{}client\`{}\ and\ \`{}scheme\`{}\ information\ so\ that\ they\ reference}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00016}00016\ \textcolor{stringliteral}{\ \ \ \ the\ connecting\ client,\ rather\ that\ the\ connecting\ proxy.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00017}00017\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00018}00018\ \textcolor{stringliteral}{\ \ \ \ References:}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00019}00019\ \textcolor{stringliteral}{\ \ \ \ -\/\ <https://developer.mozilla.org/en-\/US/docs/Web/HTTP/Headers\#Proxies>}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00020}00020\ \textcolor{stringliteral}{\ \ \ \ -\/\ <https://developer.mozilla.org/en-\/US/docs/Web/HTTP/Headers/X-\/Forwarded-\/For>}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00021}00021\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00023}00023\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self,\ app:\ ASGI3Application,\ trusted\_hosts:\ list[str]\ |\ str\ =\ \textcolor{stringliteral}{"{}127.0.0.1"{}})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00024}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a26515d308c31865196da0d516f826bc9}{00024}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a26515d308c31865196da0d516f826bc9}{app}}\ =\ app}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00025}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a99295c68bfaa468fa6403b572f263c37}{00025}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a99295c68bfaa468fa6403b572f263c37}{trusted\_hosts}}\ =\ \mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts}{\_TrustedHosts}}(trusted\_hosts)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00027}00027\ \ \ \ \ \textcolor{keyword}{async\ def\ }\_\_call\_\_(self,\ scope:\ Scope,\ receive:\ ASGIReceiveCallable,\ send:\ ASGISendCallable)\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00028}00028\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ scope[\textcolor{stringliteral}{"{}type"{}}]\ ==\ \textcolor{stringliteral}{"{}lifespan"{}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00029}00029\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ await\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a26515d308c31865196da0d516f826bc9}{app}}(scope,\ receive,\ send)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00030}00030\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ client\_addr\ =\ scope.get(\textcolor{stringliteral}{"{}client"{}})}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ client\_host\ =\ client\_addr[0]\ \textcolor{keywordflow}{if}\ client\_addr\ \textcolor{keywordflow}{else}\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ client\_host\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a99295c68bfaa468fa6403b572f263c37}{trusted\_hosts}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00035}00035\ \ \ \ \ \ \ \ \ \ \ \ \ headers\ =\ dict(scope[\textcolor{stringliteral}{"{}headers"{}}])}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00036}00036\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ b\textcolor{stringliteral}{"{}x-\/forwarded-\/proto"{}}\ \textcolor{keywordflow}{in}\ headers:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00038}00038\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ x\_forwarded\_proto\ =\ headers[b\textcolor{stringliteral}{"{}x-\/forwarded-\/proto"{}}].decode(\textcolor{stringliteral}{"{}latin1"{}}).strip()}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00039}00039\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00040}00040\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ x\_forwarded\_proto\ \textcolor{keywordflow}{in}\ \{\textcolor{stringliteral}{"{}http"{}},\ \textcolor{stringliteral}{"{}https"{}},\ \textcolor{stringliteral}{"{}ws"{}},\ \textcolor{stringliteral}{"{}wss"{}}\}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00041}00041\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ scope[\textcolor{stringliteral}{"{}type"{}}]\ ==\ \textcolor{stringliteral}{"{}websocket"{}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ scope[\textcolor{stringliteral}{"{}scheme"{}}]\ =\ x\_forwarded\_proto.replace(\textcolor{stringliteral}{"{}http"{}},\ \textcolor{stringliteral}{"{}ws"{}})}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ scope[\textcolor{stringliteral}{"{}scheme"{}}]\ =\ x\_forwarded\_proto}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00045}00045\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00046}00046\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ b\textcolor{stringliteral}{"{}x-\/forwarded-\/for"{}}\ \textcolor{keywordflow}{in}\ headers:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ x\_forwarded\_for\ =\ headers[b\textcolor{stringliteral}{"{}x-\/forwarded-\/for"{}}].decode(\textcolor{stringliteral}{"{}latin1"{}})}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ host\ =\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a99295c68bfaa468fa6403b572f263c37}{trusted\_hosts}}.get\_trusted\_client\_host(x\_forwarded\_for)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00050}00050\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ host:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00051}00051\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ If\ the\ x-\/forwarded-\/for\ header\ is\ empty\ then\ host\ is\ an\ empty\ string.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00052}00052\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Only\ set\ the\ client\ if\ we\ actually\ got\ something\ usable.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00053}00053\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ See:\ https://github.com/Kludex/uvicorn/issues/1068}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00054}00054\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00055}00055\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ We've\ lost\ the\ connecting\ client's\ port\ information\ by\ now,}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00056}00056\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ so\ only\ include\ the\ host.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00057}00057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ port\ =\ 0}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00058}00058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ scope[\textcolor{stringliteral}{"{}client"{}}]\ =\ (host,\ port)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00060}00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ await\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1_proxy_headers_middleware_a26515d308c31865196da0d516f826bc9}{app}}(scope,\ receive,\ send)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00063}\mbox{\hyperlink{namespaceuvicorn_1_1middleware_1_1proxy__headers_a941ed170f698826315a6a09eb75797ee}{00063}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceuvicorn_1_1middleware_1_1proxy__headers_a941ed170f698826315a6a09eb75797ee}{\_parse\_raw\_hosts}}(value:\ str)\ -\/>\ list[str]:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00064}00064\ \ \ \ \ \textcolor{keywordflow}{return}\ [item.strip()\ \textcolor{keywordflow}{for}\ item\ \textcolor{keywordflow}{in}\ value.split(\textcolor{stringliteral}{"{},"{}})]}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00065}00065\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00066}00066\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00067}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts}{00067}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts}{\_TrustedHosts}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00068}00068\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Container\ for\ trusted\ hosts\ and\ networks"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00069}00069\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00070}00070\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self,\ trusted\_hosts:\ list[str]\ |\ str)\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00071}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ab4447c9835305f6ab13505e9d5faaaee}{00071}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ab4447c9835305f6ab13505e9d5faaaee}{always\_trust}}:\ bool\ =\ trusted\_hosts\ \textcolor{keywordflow}{in}\ (\textcolor{stringliteral}{"{}*"{}},\ [\textcolor{stringliteral}{"{}*"{}}])}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00072}00072\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00073}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a9f1b4835f47328ebf179536f874b8b95}{00073}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a9f1b4835f47328ebf179536f874b8b95}{trusted\_literals}}:\ set[str]\ =\ set()}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00074}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a522ad36773f1f2d1ef95cebf109d836a}{00074}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a522ad36773f1f2d1ef95cebf109d836a}{trusted\_hosts}}:\ set[ipaddress.IPv4Address\ |\ ipaddress.IPv6Address]\ =\ set()}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00075}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ac22060c17e7ee1ca25ad351f8de2f541}{00075}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ac22060c17e7ee1ca25ad351f8de2f541}{trusted\_networks}}:\ set[ipaddress.IPv4Network\ |\ ipaddress.IPv6Network]\ =\ set()}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00076}00076\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00077}00077\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Notes:}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ -\/\ We\ separate\ hosts\ from\ literals\ as\ there\ are\ many\ ways\ to\ write}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ \ \ an\ IPv6\ Address\ so\ we\ need\ to\ compare\ by\ object.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00080}00080\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ -\/\ We\ don't\ convert\ IP\ Address\ to\ single\ host\ networks\ (e.g.\ /32\ /\ 128)\ as}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00081}00081\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ \ \ it\ more\ efficient\ to\ do\ an\ address\ lookup\ in\ a\ set\ than\ check\ for}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00082}00082\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ \ \ membership\ in\ each\ network.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00083}00083\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ -\/\ We\ still\ allow\ literals\ as\ it\ might\ be\ possible\ that\ we\ receive\ a}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00084}00084\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ \ \ something\ that\ isn't\ an\ IP\ Address\ e.g.\ a\ unix\ socket.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00085}00085\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00086}00086\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ab4447c9835305f6ab13505e9d5faaaee}{always\_trust}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00087}00087\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ isinstance(trusted\_hosts,\ str):}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00088}00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ trusted\_hosts\ =\ \mbox{\hyperlink{namespaceuvicorn_1_1middleware_1_1proxy__headers_a941ed170f698826315a6a09eb75797ee}{\_parse\_raw\_hosts}}(trusted\_hosts)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00089}00089\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00090}00090\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ host\ \textcolor{keywordflow}{in}\ trusted\_hosts:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00091}00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Note:\ because\ we\ always\ convert\ invalid\ IP\ types\ to\ literals\ it}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00092}00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ is\ not\ possible\ for\ the\ user\ to\ know\ they\ provided\ a\ malformed\ IP}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00093}00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ type\ -\/\ this\ may\ lead\ to\ unexpected\ /\ difficult\ to\ debug\ behaviour.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00094}00094\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00095}00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{stringliteral}{"{}/"{}}\ \textcolor{keywordflow}{in}\ host:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00096}00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Looks\ like\ a\ network}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00097}00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00098}00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ac22060c17e7ee1ca25ad351f8de2f541}{trusted\_networks}}.add(ipaddress.ip\_network(host))}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00099}00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ ValueError:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00100}00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Was\ not\ a\ valid\ IP\ Network}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00101}00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a9f1b4835f47328ebf179536f874b8b95}{trusted\_literals}}.add(host)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00102}00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00103}00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00104}00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a522ad36773f1f2d1ef95cebf109d836a}{trusted\_hosts}}.add(ipaddress.ip\_address(host))}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00105}00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ ValueError:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00106}00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Was\ not\ a\ valid\ IP\ Address}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00107}00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a9f1b4835f47328ebf179536f874b8b95}{trusted\_literals}}.add(host)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00108}00108\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00109}00109\ \ \ \ \ \textcolor{keyword}{def\ }\_\_contains\_\_(self,\ host:\ str\ |\ \textcolor{keywordtype}{None})\ -\/>\ bool:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00110}00110\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ab4447c9835305f6ab13505e9d5faaaee}{always\_trust}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00111}00111\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00112}00112\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00113}00113\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ host:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00114}00114\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00115}00115\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00116}00116\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00117}00117\ \ \ \ \ \ \ \ \ \ \ \ \ ip\ =\ ipaddress.ip\_address(host)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00118}00118\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ip\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a522ad36773f1f2d1ef95cebf109d836a}{trusted\_hosts}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00120}00120\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ any(ip\ \textcolor{keywordflow}{in}\ net\ \textcolor{keywordflow}{for}\ net\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ac22060c17e7ee1ca25ad351f8de2f541}{trusted\_networks}})}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00121}00121\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00122}00122\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ ValueError:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00123}00123\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ host\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a9f1b4835f47328ebf179536f874b8b95}{trusted\_literals}}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00124}00124\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00125}\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a0103526192d6f03b266ffad1b38aa0cd}{00125}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_a0103526192d6f03b266ffad1b38aa0cd}{get\_trusted\_client\_host}}(self,\ x\_forwarded\_for:\ str)\ -\/>\ str:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00126}00126\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Extract\ the\ client\ host\ from\ x\_forwarded\_for\ header}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00127}00127\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00128}00128\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ In\ general\ this\ is\ the\ first\ "{}untrusted"{}\ host\ in\ the\ forwarded\ for\ list.}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00129}00129\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00130}00130\ \ \ \ \ \ \ \ \ x\_forwarded\_for\_hosts\ =\ \mbox{\hyperlink{namespaceuvicorn_1_1middleware_1_1proxy__headers_a941ed170f698826315a6a09eb75797ee}{\_parse\_raw\_hosts}}(x\_forwarded\_for)}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00131}00131\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00132}00132\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1middleware_1_1proxy__headers_1_1___trusted_hosts_ab4447c9835305f6ab13505e9d5faaaee}{always\_trust}}:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00133}00133\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ x\_forwarded\_for\_hosts[0]}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00134}00134\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00135}00135\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Note:\ each\ proxy\ appends\ to\ the\ header\ list\ so\ check\ it\ in\ reverse\ order}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00136}00136\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ host\ \textcolor{keywordflow}{in}\ reversed(x\_forwarded\_for\_hosts):}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ host\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ self:}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00138}00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ host}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00139}00139\ }
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00140}00140\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ All\ hosts\ are\ trusted\ meaning\ that\ the\ client\ was\ also\ a\ trusted\ proxy}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00141}00141\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ See\ https://github.com/Kludex/uvicorn/issues/1068\#issuecomment-\/855371576}}
\DoxyCodeLine{\Hypertarget{proxy__headers_8py_source_l00142}00142\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ x\_forwarded\_for\_hosts[0]}

\end{DoxyCode}
