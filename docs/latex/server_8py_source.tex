\doxysection{server.\+py}
\hypertarget{server_8py_source}{}\label{server_8py_source}\index{micro\_gestion\_objetos/venv/Lib/site-\/packages/uvicorn/server.py@{micro\_gestion\_objetos/venv/Lib/site-\/packages/uvicorn/server.py}}
\mbox{\hyperlink{server_8py}{Ir a la documentaci√≥n de este archivo.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00001}\mbox{\hyperlink{namespaceuvicorn_1_1server}{00001}}\ \textcolor{keyword}{from}\ \_\_future\_\_\ \textcolor{keyword}{import}\ annotations}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00003}00003\ \textcolor{keyword}{import}\ asyncio}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00004}00004\ \textcolor{keyword}{import}\ contextlib}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00005}00005\ \textcolor{keyword}{import}\ logging}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00006}00006\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00007}00007\ \textcolor{keyword}{import}\ platform}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00008}00008\ \textcolor{keyword}{import}\ signal}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00009}00009\ \textcolor{keyword}{import}\ socket}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00010}00010\ \textcolor{keyword}{import}\ sys}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00011}00011\ \textcolor{keyword}{import}\ threading}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00012}00012\ \textcolor{keyword}{import}\ time}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00013}00013\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespacecollections_1_1abc}{collections.abc}}\ \textcolor{keyword}{import}\ Generator,\ Sequence}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00014}00014\ \textcolor{keyword}{from}\ email.utils\ \textcolor{keyword}{import}\ formatdate}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00015}00015\ \textcolor{keyword}{from}\ types\ \textcolor{keyword}{import}\ FrameType}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00016}00016\ \textcolor{keyword}{from}\ typing\ \textcolor{keyword}{import}\ TYPE\_CHECKING,\ Union}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00018}00018\ \textcolor{keyword}{import}\ click}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00019}00019\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00020}00020\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1__compat}{uvicorn.\_compat}}\ \textcolor{keyword}{import}\ asyncio\_run}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00021}00021\ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1config}{uvicorn.config}}\ \textcolor{keyword}{import}\ Config}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00023}00023\ \textcolor{keywordflow}{if}\ TYPE\_CHECKING:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00024}00024\ \ \ \ \ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1protocols_1_1http_1_1h11__impl}{uvicorn.protocols.http.h11\_impl}}\ \textcolor{keyword}{import}\ H11Protocol}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00025}00025\ \ \ \ \ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1protocols_1_1http_1_1httptools__impl}{uvicorn.protocols.http.httptools\_impl}}\ \textcolor{keyword}{import}\ HttpToolsProtocol}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00026}00026\ \ \ \ \ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1protocols_1_1websockets_1_1websockets__impl}{uvicorn.protocols.websockets.websockets\_impl}}\ \textcolor{keyword}{import}\ WebSocketProtocol}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00027}00027\ \ \ \ \ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1protocols_1_1websockets_1_1websockets__sansio__impl}{uvicorn.protocols.websockets.websockets\_sansio\_impl}}\ \textcolor{keyword}{import}\ WebSocketsSansIOProtocol}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00028}00028\ \ \ \ \ \textcolor{keyword}{from}\ \mbox{\hyperlink{namespaceuvicorn_1_1protocols_1_1websockets_1_1wsproto__impl}{uvicorn.protocols.websockets.wsproto\_impl}}\ \textcolor{keyword}{import}\ WSProtocol}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00030}\mbox{\hyperlink{namespaceuvicorn_1_1server_ac152aaf648b40fa8e8ce3d61b518855f}{00030}}\ \ \ \ \ Protocols\ =\ Union[H11Protocol,\ HttpToolsProtocol,\ WSProtocol,\ WebSocketProtocol,\ WebSocketsSansIOProtocol]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00031}00031\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00032}\mbox{\hyperlink{namespaceuvicorn_1_1server_a6c767b2c17aa6b0b13f84e0bbea38c2e}{00032}}\ HANDLED\_SIGNALS\ =\ (}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00033}00033\ \ \ \ \ signal.SIGINT,\ \ \textcolor{comment}{\#\ Unix\ signal\ 2.\ Sent\ by\ Ctrl+C.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00034}00034\ \ \ \ \ signal.SIGTERM,\ \ \textcolor{comment}{\#\ Unix\ signal\ 15.\ Sent\ by\ \`{}kill\ <pid>`.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00035}00035\ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00036}00036\ \textcolor{keywordflow}{if}\ sys.platform\ ==\ \textcolor{stringliteral}{"{}win32"{}}:\ \ \textcolor{comment}{\#\ pragma:\ py-\/not-\/win32}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00037}00037\ \ \ \ \ HANDLED\_SIGNALS\ +=\ (signal.SIGBREAK,)\ \ \textcolor{comment}{\#\ Windows\ signal\ 21.\ Sent\ by\ Ctrl+Break.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00039}\mbox{\hyperlink{namespaceuvicorn_1_1server_ad0988720d73b544806c02b691e9f55d1}{00039}}\ logger\ =\ logging.getLogger(\textcolor{stringliteral}{"{}uvicorn.error"{}})}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00040}00040\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00042}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state}{00042}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state}{ServerState}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00043}00043\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00044}00044\ \textcolor{stringliteral}{\ \ \ \ Shared\ servers\ state\ that\ is\ available\ between\ all\ protocol\ instances.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00045}00045\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00046}00046\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00047}00047\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self)\ -\/>\ None:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00048}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_ae8adaad23b4715959815aa398389e21a}{00048}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_ae8adaad23b4715959815aa398389e21a}{total\_requests}}\ =\ 0}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00049}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_a1ea347daa6ccf608a79086512260a996}{00049}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_a1ea347daa6ccf608a79086512260a996}{connections}}:\ set[Protocols]\ =\ set()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00050}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_a1e612b419d81da4a2098b61d93ac9862}{00050}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_a1e612b419d81da4a2098b61d93ac9862}{tasks}}:\ set[asyncio.Task[\textcolor{keywordtype}{None}]]\ =\ set()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00051}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_aeb37d429612a095eb4bf010203260978}{00051}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state_aeb37d429612a095eb4bf010203260978}{default\_headers}}:\ list[tuple[bytes,\ bytes]]\ =\ []}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00053}00053\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00054}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server}{00054}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server}{Server}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00055}00055\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self,\ config:\ Config)\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00056}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{00056}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}\ =\ config}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00057}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{00057}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}\ =\ \mbox{\hyperlink{classuvicorn_1_1server_1_1_server_state}{ServerState}}()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00058}00058\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00059}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9bd7654f808c8df3a25801fc321a4a2b}{00059}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9bd7654f808c8df3a25801fc321a4a2b}{started}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00060}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a538bbc322e44fca2c59da58b5bb80754}{00060}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a538bbc322e44fca2c59da58b5bb80754}{should\_exit}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00061}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{00061}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{force\_exit}}\ =\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00062}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a98f9ef354eb6d19cd6bb0823bdf781be}{00062}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a98f9ef354eb6d19cd6bb0823bdf781be}{last\_notified}}\ =\ 0.0}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00063}00063\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00064}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aafa65ad78611114166fb7e6e0da03f33}{00064}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aafa65ad78611114166fb7e6e0da03f33}{\_captured\_signals}}:\ list[int]\ =\ []}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00065}00065\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00066}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aa671c8b6bfd2d31f601cb9a02fe5503e}{00066}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aa671c8b6bfd2d31f601cb9a02fe5503e}{run}}(self,\ sockets:\ list[socket.socket]\ |\ \textcolor{keywordtype}{None}\ =\ \textcolor{keywordtype}{None})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00067}00067\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ asyncio\_run(self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a5dcc3f44eb3d350b6b110a43da16efb2}{serve}}(sockets=sockets),\ loop\_factory=self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.get\_loop\_factory())}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00068}00068\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00069}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a5dcc3f44eb3d350b6b110a43da16efb2}{00069}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a5dcc3f44eb3d350b6b110a43da16efb2}{serve}}(self,\ sockets:\ list[socket.socket]\ |\ \textcolor{keywordtype}{None}\ =\ \textcolor{keywordtype}{None})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00070}00070\ \ \ \ \ \ \ \ \ \textcolor{keyword}{with}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_ab1db413e79c40606b689782f50160428}{capture\_signals}}():}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00071}00071\ \ \ \ \ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a5f69bd0fa8f2491a880c86455bea0bcf}{\_serve}}(sockets)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00072}00072\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00073}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a5f69bd0fa8f2491a880c86455bea0bcf}{00073}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a5f69bd0fa8f2491a880c86455bea0bcf}{\_serve}}(self,\ sockets:\ list[socket.socket]\ |\ \textcolor{keywordtype}{None}\ =\ \textcolor{keywordtype}{None})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00074}00074\ \ \ \ \ \ \ \ \ process\_id\ =\ os.getpid()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00075}00075\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00076}00076\ \ \ \ \ \ \ \ \ config\ =\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00077}00077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ config.loaded:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ \ \ \ \ config.load()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00079}00079\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00080}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8b97408b94d715a68d2ac63066458434}{00080}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8b97408b94d715a68d2ac63066458434}{lifespan}}\ =\ config.lifespan\_class(config)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00081}00081\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00082}00082\ \ \ \ \ \ \ \ \ message\ =\ \textcolor{stringliteral}{"{}Started\ server\ process\ [\%d]"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00083}00083\ \ \ \ \ \ \ \ \ color\_message\ =\ \textcolor{stringliteral}{"{}Started\ server\ process\ ["{}}\ +\ click.style(\textcolor{stringliteral}{"{}\%d"{}},\ fg=\textcolor{stringliteral}{"{}cyan"{}})\ +\ \textcolor{stringliteral}{"{}]"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00084}00084\ \ \ \ \ \ \ \ \ logger.info(message,\ process\_id,\ extra=\{\textcolor{stringliteral}{"{}color\_message"{}}:\ color\_message\})}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00085}00085\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00086}00086\ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a536cd65fae2df0aab0023ffb13637289}{startup}}(sockets=sockets)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00087}00087\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a538bbc322e44fca2c59da58b5bb80754}{should\_exit}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00088}00088\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00089}00089\ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a3b320b4e26fc12bbc0ce81b6c176fc4b}{main\_loop}}()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00090}00090\ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8bfa0d276e5167934224d6bd38bd46a1}{shutdown}}(sockets=sockets)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00091}00091\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00092}00092\ \ \ \ \ \ \ \ \ message\ =\ \textcolor{stringliteral}{"{}Finished\ server\ process\ [\%d]"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00093}00093\ \ \ \ \ \ \ \ \ color\_message\ =\ \textcolor{stringliteral}{"{}Finished\ server\ process\ ["{}}\ +\ click.style(\textcolor{stringliteral}{"{}\%d"{}},\ fg=\textcolor{stringliteral}{"{}cyan"{}})\ +\ \textcolor{stringliteral}{"{}]"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00094}00094\ \ \ \ \ \ \ \ \ logger.info(message,\ process\_id,\ extra=\{\textcolor{stringliteral}{"{}color\_message"{}}:\ color\_message\})}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00095}00095\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00096}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a536cd65fae2df0aab0023ffb13637289}{00096}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a536cd65fae2df0aab0023ffb13637289}{startup}}(self,\ sockets:\ list[socket.socket]\ |\ \textcolor{keywordtype}{None}\ =\ \textcolor{keywordtype}{None})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00097}00097\ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8b97408b94d715a68d2ac63066458434}{lifespan}}.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a536cd65fae2df0aab0023ffb13637289}{startup}}()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00098}00098\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8b97408b94d715a68d2ac63066458434}{lifespan}}.should\_exit:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00099}00099\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a538bbc322e44fca2c59da58b5bb80754}{should\_exit}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00100}00100\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00101}00101\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00102}00102\ \ \ \ \ \ \ \ \ config\ =\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00103}00103\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00104}00104\ \ \ \ \ \ \ \ \ \textcolor{keyword}{def\ }create\_protocol(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00105}00105\ \ \ \ \ \ \ \ \ \ \ \ \ \_loop:\ asyncio.AbstractEventLoop\ |\ \textcolor{keywordtype}{None}\ =\ \textcolor{keywordtype}{None},}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00106}00106\ \ \ \ \ \ \ \ \ )\ -\/>\ asyncio.Protocol:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00107}00107\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ config.http\_protocol\_class(\ \ \textcolor{comment}{\#\ type:\ ignore[call-\/arg]}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00108}00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ config=config,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00109}00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server\_state=self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}},}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00110}00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ app\_state=self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8b97408b94d715a68d2ac63066458434}{lifespan}}.state,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00111}00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_loop=\_loop,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00112}00112\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00113}00113\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00114}00114\ \ \ \ \ \ \ \ \ loop\ =\ asyncio.get\_running\_loop()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00115}00115\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00116}00116\ \ \ \ \ \ \ \ \ listeners:\ Sequence[socket.SocketType]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00117}00117\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ sockets\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:\ \ \textcolor{comment}{\#\ pragma:\ full\ coverage}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00118}00118\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Explicitly\ passed\ a\ list\ of\ open\ sockets.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ We\ use\ this\ when\ the\ server\ is\ run\ from\ a\ Gunicorn\ worker.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00120}00120\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00121}00121\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{def\ }\_share\_socket(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00122}00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sock:\ socket.SocketType,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00123}00123\ \ \ \ \ \ \ \ \ \ \ \ \ )\ -\/>\ socket.SocketType:\ \ \textcolor{comment}{\#\ pragma\ py-\/not-\/win32}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00124}00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Windows\ requires\ the\ socket\ be\ explicitly\ shared\ across}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00125}00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ multiple\ workers\ (processes).}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00126}00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{from}\ socket\ \textcolor{keyword}{import}\ fromshare\ \ \textcolor{comment}{\#\ type:\ ignore[attr-\/defined]}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00127}00127\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00128}00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sock\_data\ =\ sock.share(os.getpid())\ \ \textcolor{comment}{\#\ type:\ ignore[attr-\/defined]}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00129}00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ fromshare(sock\_data)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00130}00130\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00131}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{00131}}\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{servers}}:\ list[asyncio.base\_events.Server]\ =\ []}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00132}00132\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ sock\ \textcolor{keywordflow}{in}\ sockets:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00133}00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ is\_windows\ =\ platform.system()\ ==\ \textcolor{stringliteral}{"{}Windows"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00134}00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ config.workers\ >\ 1\ \textcolor{keywordflow}{and}\ is\_windows:\ \ \textcolor{comment}{\#\ pragma:\ py-\/not-\/win32}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00135}00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sock\ =\ \_share\_socket(sock)\ \ \textcolor{comment}{\#\ type:\ ignore[assignment]}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00136}00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server\ =\ await\ loop.create\_server(create\_protocol,\ sock=sock,\ ssl=config.ssl,\ backlog=config.backlog)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{servers}}.append(server)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00138}00138\ \ \ \ \ \ \ \ \ \ \ \ \ listeners\ =\ sockets}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00139}00139\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00140}00140\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ config.fd\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:\ \ \textcolor{comment}{\#\ pragma:\ py-\/win32}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00141}00141\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Use\ an\ existing\ socket,\ from\ a\ file\ descriptor.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00142}00142\ \ \ \ \ \ \ \ \ \ \ \ \ sock\ =\ socket.fromfd(config.fd,\ socket.AF\_UNIX,\ socket.SOCK\_STREAM)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00143}00143\ \ \ \ \ \ \ \ \ \ \ \ \ server\ =\ await\ loop.create\_server(create\_protocol,\ sock=sock,\ ssl=config.ssl,\ backlog=config.backlog)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00144}00144\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{assert}\ server.sockets\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}\ \ \textcolor{comment}{\#\ mypy}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \ \ \ listeners\ =\ server.sockets}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{servers}}\ =\ [server]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00147}00147\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00148}00148\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ config.uds\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:\ \ \textcolor{comment}{\#\ pragma:\ py-\/win32}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00149}00149\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Create\ a\ socket\ using\ UNIX\ domain\ socket.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00150}00150\ \ \ \ \ \ \ \ \ \ \ \ \ uds\_perms\ =\ 0o666}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00151}00151\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ os.path.exists(config.uds):}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00152}00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uds\_perms\ =\ os.stat(config.uds).st\_mode\ \ \textcolor{comment}{\#\ pragma:\ full\ coverage}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00153}00153\ \ \ \ \ \ \ \ \ \ \ \ \ server\ =\ await\ loop.create\_unix\_server(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00154}00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ create\_protocol,\ path=config.uds,\ ssl=config.ssl,\ backlog=config.backlog}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ os.chmod(config.uds,\ uds\_perms)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00157}00157\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{assert}\ server.sockets\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}\ \ \textcolor{comment}{\#\ mypy}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ listeners\ =\ server.sockets}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{servers}}\ =\ [server]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00160}00160\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00162}00162\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Standard\ case.\ Create\ a\ socket\ from\ a\ host/port\ pair.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ server\ =\ await\ loop.create\_server(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00165}00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ create\_protocol,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00166}00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ host=config.host,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00167}00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ port=config.port,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00168}00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ssl=config.ssl,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00169}00169\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ backlog=config.backlog,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00171}00171\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ OSError\ \textcolor{keyword}{as}\ exc:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00172}00172\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ logger.error(exc)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00173}00173\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8b97408b94d715a68d2ac63066458434}{lifespan}}.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8bfa0d276e5167934224d6bd38bd46a1}{shutdown}}()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00174}00174\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sys.exit(1)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00175}00175\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00176}00176\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{assert}\ server.sockets\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00177}00177\ \ \ \ \ \ \ \ \ \ \ \ \ listeners\ =\ server.sockets}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00178}00178\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{servers}}\ =\ [server]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00179}00179\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00180}00180\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ sockets\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00181}00181\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aa7227b29c4f335b55675971757af1c59}{\_log\_started\_message}}(listeners)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00182}00182\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00183}00183\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ We're\ most\ likely\ running\ multiple\ workers,\ so\ a\ message\ has\ already\ been}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00184}00184\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ logged\ by\ \`{}config.bind\_socket()`.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00185}00185\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{pass}\ \ \textcolor{comment}{\#\ pragma:\ full\ coverage}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00186}00186\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00187}00187\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9bd7654f808c8df3a25801fc321a4a2b}{started}}\ =\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00188}00188\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00189}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aa7227b29c4f335b55675971757af1c59}{00189}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aa7227b29c4f335b55675971757af1c59}{\_log\_started\_message}}(self,\ listeners:\ Sequence[socket.SocketType])\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00190}00190\ \ \ \ \ \ \ \ \ config\ =\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00191}00191\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00192}00192\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ config.fd\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:\ \ \textcolor{comment}{\#\ pragma:\ py-\/win32}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00193}00193\ \ \ \ \ \ \ \ \ \ \ \ \ sock\ =\ listeners[0]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00194}00194\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00195}00195\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Uvicorn\ running\ on\ socket\ \%s\ (Press\ CTRL+C\ to\ quit)"{}},}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00196}00196\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ sock.getsockname(),}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00197}00197\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00198}00198\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00199}00199\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ config.uds\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:\ \ \textcolor{comment}{\#\ pragma:\ py-\/win32}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00200}00200\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(\textcolor{stringliteral}{"{}Uvicorn\ running\ on\ unix\ socket\ \%s\ (Press\ CTRL+C\ to\ quit)"{}},\ config.uds)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00201}00201\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00202}00202\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00203}00203\ \ \ \ \ \ \ \ \ \ \ \ \ addr\_format\ =\ \textcolor{stringliteral}{"{}\%s://\%s:\%d"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00204}00204\ \ \ \ \ \ \ \ \ \ \ \ \ host\ =\ \textcolor{stringliteral}{"{}0.0.0.0"{}}\ \textcolor{keywordflow}{if}\ config.host\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}\ \textcolor{keywordflow}{else}\ config.host}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00205}00205\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{stringliteral}{"{}:"{}}\ \textcolor{keywordflow}{in}\ host:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00206}00206\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ It's\ an\ IPv6\ address.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00207}00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ addr\_format\ =\ \textcolor{stringliteral}{"{}\%s://[\%s]:\%d"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00208}00208\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00209}00209\ \ \ \ \ \ \ \ \ \ \ \ \ port\ =\ config.port}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00210}00210\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ port\ ==\ 0:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00211}00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ port\ =\ listeners[0].getsockname()[1]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00212}00212\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00213}00213\ \ \ \ \ \ \ \ \ \ \ \ \ protocol\_name\ =\ \textcolor{stringliteral}{"{}https"{}}\ \textcolor{keywordflow}{if}\ config.ssl\ \textcolor{keywordflow}{else}\ \textcolor{stringliteral}{"{}http"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00214}00214\ \ \ \ \ \ \ \ \ \ \ \ \ message\ =\ f\textcolor{stringliteral}{"{}Uvicorn\ running\ on\ \{addr\_format\}\ (Press\ CTRL+C\ to\ quit)"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00215}00215\ \ \ \ \ \ \ \ \ \ \ \ \ color\_message\ =\ \textcolor{stringliteral}{"{}Uvicorn\ running\ on\ "{}}\ +\ click.style(addr\_format,\ bold=\textcolor{keyword}{True})\ +\ \textcolor{stringliteral}{"{}\ (Press\ CTRL+C\ to\ quit)"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00216}00216\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00217}00217\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ message,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00218}00218\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ protocol\_name,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00219}00219\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ host,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00220}00220\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ port,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00221}00221\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ extra=\{\textcolor{stringliteral}{"{}color\_message"{}}:\ color\_message\},}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00222}00222\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00223}00223\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00224}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a3b320b4e26fc12bbc0ce81b6c176fc4b}{00224}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a3b320b4e26fc12bbc0ce81b6c176fc4b}{main\_loop}}(self)\ -\/>\ None:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00225}00225\ \ \ \ \ \ \ \ \ counter\ =\ 0}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00226}00226\ \ \ \ \ \ \ \ \ should\_exit\ =\ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aabea5ad8a0d95fbe3bc62c1db012e68e}{on\_tick}}(counter)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00227}00227\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ \textcolor{keywordflow}{not}\ should\_exit:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00228}00228\ \ \ \ \ \ \ \ \ \ \ \ \ counter\ +=\ 1}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00229}00229\ \ \ \ \ \ \ \ \ \ \ \ \ counter\ =\ counter\ \%\ 864000}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00230}00230\ \ \ \ \ \ \ \ \ \ \ \ \ await\ asyncio.sleep(0.1)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00231}00231\ \ \ \ \ \ \ \ \ \ \ \ \ should\_exit\ =\ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aabea5ad8a0d95fbe3bc62c1db012e68e}{on\_tick}}(counter)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00232}00232\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00233}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aabea5ad8a0d95fbe3bc62c1db012e68e}{00233}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aabea5ad8a0d95fbe3bc62c1db012e68e}{on\_tick}}(self,\ counter:\ int)\ -\/>\ bool:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00234}00234\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Update\ the\ default\ headers,\ once\ per\ second.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00235}00235\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ counter\ \%\ 10\ ==\ 0:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00236}00236\ \ \ \ \ \ \ \ \ \ \ \ \ current\_time\ =\ time.time()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00237}00237\ \ \ \ \ \ \ \ \ \ \ \ \ current\_date\ =\ formatdate(current\_time,\ usegmt=\textcolor{keyword}{True}).encode()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00238}00238\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00239}00239\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.date\_header:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00240}00240\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ date\_header\ =\ [(b\textcolor{stringliteral}{"{}date"{}},\ current\_date)]}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00241}00241\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00242}00242\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ date\_header\ =\ []}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00243}00243\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00244}00244\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.default\_headers\ =\ date\_header\ +\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.encoded\_headers}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00245}00245\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00246}00246\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Callback\ to\ \`{}callback\_notify`\ once\ every\ \`{}timeout\_notify`\ seconds.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00247}00247\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.callback\_notify\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00248}00248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ current\_time\ -\/\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a98f9ef354eb6d19cd6bb0823bdf781be}{last\_notified}}\ >\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.timeout\_notify:\ \ \textcolor{comment}{\#\ pragma:\ full\ coverage}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00249}00249\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a98f9ef354eb6d19cd6bb0823bdf781be}{last\_notified}}\ =\ current\_time}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00250}00250\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.callback\_notify()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00251}00251\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00252}00252\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Determine\ if\ we\ should\ exit.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00253}00253\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a538bbc322e44fca2c59da58b5bb80754}{should\_exit}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00254}00254\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00255}00255\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00256}00256\ \ \ \ \ \ \ \ \ max\_requests\ =\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.limit\_max\_requests}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00257}00257\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ max\_requests\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ \textcolor{keywordtype}{None}\ \textcolor{keywordflow}{and}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.total\_requests\ >=\ max\_requests:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00258}00258\ \ \ \ \ \ \ \ \ \ \ \ \ logger.warning(f\textcolor{stringliteral}{"{}Maximum\ request\ limit\ of\ \{max\_requests\}\ exceeded.\ Terminating\ process."{}})}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00259}00259\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{True}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00260}00260\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00261}00261\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00262}00262\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00263}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8bfa0d276e5167934224d6bd38bd46a1}{00263}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8bfa0d276e5167934224d6bd38bd46a1}{shutdown}}(self,\ sockets:\ list[socket.socket]\ |\ \textcolor{keywordtype}{None}\ =\ \textcolor{keywordtype}{None})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00264}00264\ \ \ \ \ \ \ \ \ logger.info(\textcolor{stringliteral}{"{}Shutting\ down"{}})}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00265}00265\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00266}00266\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Stop\ accepting\ new\ connections.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00267}00267\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ server\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{servers}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00268}00268\ \ \ \ \ \ \ \ \ \ \ \ \ server.close()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00269}00269\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ sock\ \textcolor{keywordflow}{in}\ sockets\ \textcolor{keywordflow}{or}\ []:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00270}00270\ \ \ \ \ \ \ \ \ \ \ \ \ sock.close()\ \ \textcolor{comment}{\#\ pragma:\ full\ coverage}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00271}00271\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00272}00272\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Request\ shutdown\ on\ all\ existing\ connections.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00273}00273\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ connection\ \textcolor{keywordflow}{in}\ list(self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.connections):}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00274}00274\ \ \ \ \ \ \ \ \ \ \ \ \ connection.shutdown()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00275}00275\ \ \ \ \ \ \ \ \ await\ asyncio.sleep(0.1)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00276}00276\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00277}00277\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ When\ 3.10\ is\ not\ supported\ anymore,\ use\ \`{}async\ with\ asyncio.timeout(...):`.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00278}00278\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00279}00279\ \ \ \ \ \ \ \ \ \ \ \ \ await\ asyncio.wait\_for(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00280}00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a54abb9472f4ca970fe92fda64a8f030d}{\_wait\_tasks\_to\_complete}}(),}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00281}00281\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ timeout=self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a1966275aa3a079010a6720f9907f93e6}{config}}.timeout\_graceful\_shutdown,}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00282}00282\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00283}00283\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ asyncio.TimeoutError:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00284}00284\ \ \ \ \ \ \ \ \ \ \ \ \ logger.error(}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00285}00285\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Cancel\ \%s\ running\ task(s),\ timeout\ graceful\ shutdown\ exceeded"{}},}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00286}00286\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ len(self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.tasks),}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00287}00287\ \ \ \ \ \ \ \ \ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00288}00288\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ t\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.tasks:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00289}00289\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ t.cancel(msg=\textcolor{stringliteral}{"{}Task\ cancelled,\ timeout\ graceful\ shutdown\ exceeded"{}})}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00290}00290\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00291}00291\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Send\ the\ lifespan\ shutdown\ event,\ and\ wait\ for\ application\ shutdown.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00292}00292\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{force\_exit}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00293}00293\ \ \ \ \ \ \ \ \ \ \ \ \ await\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8b97408b94d715a68d2ac63066458434}{lifespan}}.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a8bfa0d276e5167934224d6bd38bd46a1}{shutdown}}()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00294}00294\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00295}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a54abb9472f4ca970fe92fda64a8f030d}{00295}}\ \ \ \ \ \textcolor{keyword}{async\ def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a54abb9472f4ca970fe92fda64a8f030d}{\_wait\_tasks\_to\_complete}}(self)\ -\/>\ None:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00296}00296\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Wait\ for\ existing\ connections\ to\ finish\ sending\ responses.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00297}00297\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.connections\ \textcolor{keywordflow}{and}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{force\_exit}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00298}00298\ \ \ \ \ \ \ \ \ \ \ \ \ msg\ =\ \textcolor{stringliteral}{"{}Waiting\ for\ connections\ to\ close.\ (CTRL+C\ to\ force\ quit)"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00299}00299\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(msg)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00300}00300\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.connections\ \textcolor{keywordflow}{and}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{force\_exit}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00301}00301\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ asyncio.sleep(0.1)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00302}00302\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00303}00303\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Wait\ for\ existing\ tasks\ to\ complete.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00304}00304\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.tasks\ \textcolor{keywordflow}{and}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{force\_exit}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00305}00305\ \ \ \ \ \ \ \ \ \ \ \ \ msg\ =\ \textcolor{stringliteral}{"{}Waiting\ for\ background\ tasks\ to\ complete.\ (CTRL+C\ to\ force\ quit)"{}}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00306}00306\ \ \ \ \ \ \ \ \ \ \ \ \ logger.info(msg)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00307}00307\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a636b2884c17a547edd56da512e9a0389}{server\_state}}.tasks\ \textcolor{keywordflow}{and}\ \textcolor{keywordflow}{not}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{force\_exit}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00308}00308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ asyncio.sleep(0.1)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00309}00309\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00310}00310\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ server\ \textcolor{keywordflow}{in}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9be8df71123c51a956c01acfdb626eb5}{servers}}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00311}00311\ \ \ \ \ \ \ \ \ \ \ \ \ await\ server.wait\_closed()}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00312}00312\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00313}00313\ \ \ \ \ \textcolor{preprocessor}{@contextlib.contextmanager}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00314}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_ab1db413e79c40606b689782f50160428}{00314}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_ab1db413e79c40606b689782f50160428}{capture\_signals}}(self)\ -\/>\ Generator[None,\ None,\ None]:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00315}00315\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Signals\ can\ only\ be\ listened\ to\ from\ the\ main\ thread.}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00316}00316\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ threading.current\_thread()\ \textcolor{keywordflow}{is}\ \textcolor{keywordflow}{not}\ threading.main\_thread():}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00317}00317\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00318}00318\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00319}00319\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ always\ use\ signal.signal,\ even\ if\ loop.add\_signal\_handler\ is\ available}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00320}00320\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ this\ allows\ to\ restore\ previous\ signal\ handlers\ later\ on}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00321}00321\ \ \ \ \ \ \ \ \ original\_handlers\ =\ \{sig:\ signal.signal(sig,\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_af32e07a356f293ef3210ef4e0394bda2}{handle\_exit}})\ \textcolor{keywordflow}{for}\ sig\ \textcolor{keywordflow}{in}\ HANDLED\_SIGNALS\}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00322}00322\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00323}00323\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{yield}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00324}00324\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{finally}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00325}00325\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ sig,\ handler\ \textcolor{keywordflow}{in}\ original\_handlers.items():}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00326}00326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ signal.signal(sig,\ handler)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00327}00327\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ If\ we\ did\ gracefully\ shut\ down\ due\ to\ a\ signal,\ try\ to}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00328}00328\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ trigger\ the\ expected\ behaviour\ now;\ multiple\ signals\ would\ be}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00329}00329\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ done\ LIFO,\ see\ https://stackoverflow.com/questions/48434964}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00330}00330\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ captured\_signal\ \textcolor{keywordflow}{in}\ reversed(self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aafa65ad78611114166fb7e6e0da03f33}{\_captured\_signals}}):}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00331}00331\ \ \ \ \ \ \ \ \ \ \ \ \ signal.raise\_signal(captured\_signal)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00332}00332\ }
\DoxyCodeLine{\Hypertarget{server_8py_source_l00333}\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_af32e07a356f293ef3210ef4e0394bda2}{00333}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_af32e07a356f293ef3210ef4e0394bda2}{handle\_exit}}(self,\ sig:\ int,\ frame:\ FrameType\ |\ \textcolor{keywordtype}{None})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00334}00334\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_aafa65ad78611114166fb7e6e0da03f33}{\_captured\_signals}}.append(sig)}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00335}00335\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a538bbc322e44fca2c59da58b5bb80754}{should\_exit}}\ \textcolor{keywordflow}{and}\ sig\ ==\ signal.SIGINT:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00336}00336\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a9eca2f9aefaab3e5395f5a14e9a281f4}{force\_exit}}\ =\ \textcolor{keyword}{True}\ \ \textcolor{comment}{\#\ pragma:\ full\ coverage}}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00337}00337\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{server_8py_source_l00338}00338\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classuvicorn_1_1server_1_1_server_a538bbc322e44fca2c59da58b5bb80754}{should\_exit}}\ =\ \textcolor{keyword}{True}}

\end{DoxyCode}
